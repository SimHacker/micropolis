<library>


    <!-- Journal View -->
    <!-- Written for Micropolis -->
    <!-- By Don Hopkins -->
    <!-- Licensed under GPLv3 -->


    <class name="journalview"
        clip="true"
    >


	<attribute name="active" value="true"/>
        <attribute name="messages" value="$once{[]}"/>
	<attribute name="maxMessages" value="100"/>
	<attribute name="gap" value="5"/>


	<handler name="onmessage" reference="gApp"><![CDATA[
	    var message = gApp.message;
	    var number = message['number'];
	    var x = message['x'];
	    var y = message['y'];

	    this.addNotice(number, x, y);
	  ]]>
	</handler>


	<method name="addNotice" args="number, x, y"><![CDATA[
	    if (!number) {
	        return;
	    }
	    var notice = gNoticeView.findNotice(number);
	    if (!notice) {
	        return;
	    }
	    var attributes = notice.attributes;
	    var title = attributes['title'];
	    var description = gNoticeView.getNoticeDescription(notice);
	    var html =
	        '<b>' + title + '</b>' + '<br/>' + 
		description;
	    this.addMessage(html);
	  ]]>
	</method>


	<method name="addMessage" args="message"><![CDATA[
	    var messages = this.messages;
	    var maxMessages = this.maxMessages;
	    messages.push(message);
	    while (messages.length > maxMessages) {
	        messages.shift();
	    }
	    var html = messages.join('<br/>');
	    var textView = this.v.textView;
	    textView.setAttribute("text", html);
	    var viewHeight = this.v.height;
	    var textHeight = textView.height;
	    var textBottom = textView.y + textHeight;
	    var pastBottom = textBottom - viewHeight;
	    if (pastBottom < viewHeight) {
	        textView.setAttribute("y", -textHeight + viewHeight);
	    }
	  ]]>
	</method>


	<method name="enterText" args="text"><![CDATA[
	    gApp.sendChatText(text);
	    text = gApp.escapeHTML(text);
	    this.addMessage('<b>Me> </b>' + text);
	  ]]>
	</method>


	<view name="v"
	    width="${parent.width}"
	    height="${parent.textField.y - parent.gap}"
	    clip="true"
	>

	    <vscrollbar/>

	    <text name="textView"
		multiline="true"
		selectable="true"
		text=""
		width="${parent.width - 20}"
	    />

	</view>

	<edittext name="textField" id="gTextField"
	    x="0"
	    y="${parent.height - this.height}"
	    width="${parent.width}"
	    height="28"
	    fontsize="14"
	    fontstyle="bold"
	>

	    <handler name="onkeydown" args="key"><![CDATA[
	        //Debug.write("textField onkeydown", key);
		if (key == 13) {
		   classroot.enterText(this.text);
		   this.setAttribute("text", "");
		}
	      ]]>
	    </handler>

	</edittext>

    </class>


</library>
