<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Micropolis: MicropolisEngine/src/sprite.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>MicropolisEngine/src/sprite.cpp</h1><a href="sprite_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* sprite.cpp</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * Micropolis, Unix Version.  This game was released for the Unix platform</span>
<a name="l00004"></a>00004 <span class="comment"> * in or about 1990 and has been modified for inclusion in the One Laptop</span>
<a name="l00005"></a>00005 <span class="comment"> * Per Child program.  Copyright (C) 1989 - 2007 Electronic Arts Inc.  If</span>
<a name="l00006"></a>00006 <span class="comment"> * you need assistance with this program, you may contact:</span>
<a name="l00007"></a>00007 <span class="comment"> *   http://wiki.laptop.org/go/Micropolis  or email  micropolis@laptop.org.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software: you can redistribute it and/or modify</span>
<a name="l00010"></a>00010 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00011"></a>00011 <span class="comment"> * the Free Software Foundation, either version 3 of the License, or (at</span>
<a name="l00012"></a>00012 <span class="comment"> * your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00015"></a>00015 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00017"></a>00017 <span class="comment"> * General Public License for more details.  You should have received a</span>
<a name="l00018"></a>00018 <span class="comment"> * copy of the GNU General Public License along with this program.  If</span>
<a name="l00019"></a>00019 <span class="comment"> * not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> *             ADDITIONAL TERMS per GNU GPL Section 7</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * No trademark or publicity rights are granted.  This license does NOT</span>
<a name="l00024"></a>00024 <span class="comment"> * give you any right, title or interest in the trademark SimCity or any</span>
<a name="l00025"></a>00025 <span class="comment"> * other Electronic Arts trademark.  You may not distribute any</span>
<a name="l00026"></a>00026 <span class="comment"> * modification of this program using the trademark SimCity or claim any</span>
<a name="l00027"></a>00027 <span class="comment"> * affliation or association with Electronic Arts Inc. or its employees.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * Any propagation or conveyance of this program must include this</span>
<a name="l00030"></a>00030 <span class="comment"> * copyright notice and these terms.</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * If you convey this program (or any modifications of it) and assume</span>
<a name="l00033"></a>00033 <span class="comment"> * contractual liability for the program to recipients of it, you agree</span>
<a name="l00034"></a>00034 <span class="comment"> * to indemnify Electronic Arts for any liability that those contractual</span>
<a name="l00035"></a>00035 <span class="comment"> * assumptions impose on Electronic Arts.</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * You may not misrepresent the origins of this program; modified</span>
<a name="l00038"></a>00038 <span class="comment"> * versions of the program must be marked as such and not identified as</span>
<a name="l00039"></a>00039 <span class="comment"> * the original program.</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> * This disclaimer supplements the one included in the General Public</span>
<a name="l00042"></a>00042 <span class="comment"> * License.  TO THE FULLEST EXTENT PERMISSIBLE UNDER APPLICABLE LAW, THIS</span>
<a name="l00043"></a>00043 <span class="comment"> * PROGRAM IS PROVIDED TO YOU "AS IS," WITH ALL FAULTS, WITHOUT WARRANTY</span>
<a name="l00044"></a>00044 <span class="comment"> * OF ANY KIND, AND YOUR USE IS AT YOUR SOLE RISK.  THE ENTIRE RISK OF</span>
<a name="l00045"></a>00045 <span class="comment"> * SATISFACTORY QUALITY AND PERFORMANCE RESIDES WITH YOU.  ELECTRONIC ARTS</span>
<a name="l00046"></a>00046 <span class="comment"> * DISCLAIMS ANY AND ALL EXPRESS, IMPLIED OR STATUTORY WARRANTIES,</span>
<a name="l00047"></a>00047 <span class="comment"> * INCLUDING IMPLIED WARRANTIES OF MERCHANTABILITY, SATISFACTORY QUALITY,</span>
<a name="l00048"></a>00048 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE, NONINFRINGEMENT OF THIRD PARTY</span>
<a name="l00049"></a>00049 <span class="comment"> * RIGHTS, AND WARRANTIES (IF ANY) ARISING FROM A COURSE OF DEALING,</span>
<a name="l00050"></a>00050 <span class="comment"> * USAGE, OR TRADE PRACTICE.  ELECTRONIC ARTS DOES NOT WARRANT AGAINST</span>
<a name="l00051"></a>00051 <span class="comment"> * INTERFERENCE WITH YOUR ENJOYMENT OF THE PROGRAM; THAT THE PROGRAM WILL</span>
<a name="l00052"></a>00052 <span class="comment"> * MEET YOUR REQUIREMENTS; THAT OPERATION OF THE PROGRAM WILL BE</span>
<a name="l00053"></a>00053 <span class="comment"> * UNINTERRUPTED OR ERROR-FREE, OR THAT THE PROGRAM WILL BE COMPATIBLE</span>
<a name="l00054"></a>00054 <span class="comment"> * WITH THIRD PARTY SOFTWARE OR THAT ANY ERRORS IN THE PROGRAM WILL BE</span>
<a name="l00055"></a>00055 <span class="comment"> * CORRECTED.  NO ORAL OR WRITTEN ADVICE PROVIDED BY ELECTRONIC ARTS OR</span>
<a name="l00056"></a>00056 <span class="comment"> * ANY AUTHORIZED REPRESENTATIVE SHALL CREATE A WARRANTY.  SOME</span>
<a name="l00057"></a>00057 <span class="comment"> * JURISDICTIONS DO NOT ALLOW THE EXCLUSION OF OR LIMITATIONS ON IMPLIED</span>
<a name="l00058"></a>00058 <span class="comment"> * WARRANTIES OR THE LIMITATIONS ON THE APPLICABLE STATUTORY RIGHTS OF A</span>
<a name="l00059"></a>00059 <span class="comment"> * CONSUMER, SO SOME OR ALL OF THE ABOVE EXCLUSIONS AND LIMITATIONS MAY</span>
<a name="l00060"></a>00060 <span class="comment"> * NOT APPLY TO YOU.</span>
<a name="l00061"></a>00061 <span class="comment"> */</span>
<a name="l00062"></a>00062 
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include "stdafx.h"</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include "<a class="code" href="micropolis_8h.html">micropolis.h</a>"</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="preprocessor">#define TRA_GROOVE_X -39</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#define TRA_GROOVE_Y 6</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#define BUS_GROOVE_X -39</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#define BUS_GROOVE_Y 6</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 
<a name="l00093"></a><a class="code" href="classMicropolis.html#c704db0c9cdd214f77e69f58e4717d65">00093</a> <a class="code" href="classSimSprite.html">SimSprite</a> *<a class="code" href="classMicropolis.html#c704db0c9cdd214f77e69f58e4717d65">Micropolis::newSprite</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095     <a class="code" href="classSimSprite.html">SimSprite</a> *sprite;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="comment">// If a sprite is available at the pool, use one.</span>
<a name="l00098"></a>00098     <span class="comment">// else, allocate a new one.</span>
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#48947512d497950ae91b99914b83f1e2" title="Pool of free SimSprite objects.">freeSprites</a>) {
<a name="l00100"></a>00100         sprite = <a class="code" href="classMicropolis.html#48947512d497950ae91b99914b83f1e2" title="Pool of free SimSprite objects.">freeSprites</a>;
<a name="l00101"></a>00101         <a class="code" href="classMicropolis.html#48947512d497950ae91b99914b83f1e2" title="Pool of free SimSprite objects.">freeSprites</a> = sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>;
<a name="l00102"></a>00102     } <span class="keywordflow">else</span> {
<a name="l00103"></a>00103         sprite = (<a class="code" href="classSimSprite.html">SimSprite</a> *)<a class="code" href="classMicropolis.html#d501381b15fa6d05221f0b40df34c292">newPtr</a>(<span class="keyword">sizeof</span> (<a class="code" href="classSimSprite.html">SimSprite</a>));
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     sprite-&gt;<a class="code" href="classSimSprite.html#00009c29518d182f8562608c62e9d4b9" title="Name of the sprite.">name</a> = (<span class="keywordtype">char</span> *)<a class="code" href="classMicropolis.html#d501381b15fa6d05221f0b40df34c292">newPtr</a>((<span class="keywordtype">int</span>)strlen(name) + 1);
<a name="l00107"></a>00107     strcpy(sprite-&gt;<a class="code" href="classSimSprite.html#00009c29518d182f8562608c62e9d4b9" title="Name of the sprite.">name</a>, name);
<a name="l00108"></a>00108     sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> = type;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <a class="code" href="classMicropolis.html#234d173bdcc0780c131daf8be911e5e9">initSprite</a>(sprite, x, y);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a> = <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>;
<a name="l00113"></a>00113     <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a> = sprite;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="keywordflow">return</span> sprite;
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 
<a name="l00126"></a><a class="code" href="classMicropolis.html#234d173bdcc0780c131daf8be911e5e9">00126</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#234d173bdcc0780c131daf8be911e5e9">Micropolis::initSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128     sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> = x;
<a name="l00129"></a>00129     sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> = y;
<a name="l00130"></a>00130     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l00131"></a>00131     sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a> = 0;
<a name="l00132"></a>00132     sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a> = 0;
<a name="l00133"></a>00133     sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = 0;
<a name="l00134"></a>00134     sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = 0;
<a name="l00135"></a>00135     sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 0;
<a name="l00136"></a>00136     sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> = 0;
<a name="l00137"></a>00137     sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = 0;
<a name="l00138"></a>00138     sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a> = 0;
<a name="l00139"></a>00139     sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a> = 0;
<a name="l00140"></a>00140     sprite-&gt;<a class="code" href="classSimSprite.html#1a3ba93b6493a6fd7af4f5a9175bc2ac">flag</a> = 0;
<a name="l00141"></a>00141     sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a> = -1;
<a name="l00142"></a>00142     sprite-&gt;<a class="code" href="classSimSprite.html#2752bdba73b42e8af8e139bfd08a03ba">turn</a> = 0;
<a name="l00143"></a>00143     sprite-&gt;<a class="code" href="classSimSprite.html#444c32353014fed8b55fb0352883fbe1">accel</a> = 0;
<a name="l00144"></a>00144     sprite-&gt;<a class="code" href="classSimSprite.html#3fa74306df63340813b6e41d805d4ec9">speed</a> = 100;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (globalSprites[sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a>] == NULL) {
<a name="l00147"></a>00147         globalSprites[sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a>] = sprite;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="keywordflow">switch</span> (sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a>) {
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a>:
<a name="l00153"></a>00153             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 32;
<a name="l00154"></a>00154             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 32;
<a name="l00155"></a>00155             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 32;
<a name="l00156"></a>00156             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = -16;
<a name="l00157"></a>00157             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 40;
<a name="l00158"></a>00158             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = -8;
<a name="l00159"></a>00159             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 1;
<a name="l00160"></a>00160             sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = 4;
<a name="l00161"></a>00161             <span class="keywordflow">break</span>;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab6ba5d8c2fd181feca500a46b00ef860" title="Ship.">SPRITE_SHIP</a>:
<a name="l00164"></a>00164             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 48;
<a name="l00165"></a>00165             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 48;
<a name="l00166"></a>00166             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 32;
<a name="l00167"></a>00167             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = -16;
<a name="l00168"></a>00168             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 48;
<a name="l00169"></a>00169             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = 0;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171             <span class="keywordflow">if</span> (x &lt; (4 &lt;&lt;4)) {
<a name="l00172"></a>00172                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 3;
<a name="l00173"></a>00173             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &gt;= ((<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 4) &lt;&lt;4)) {
<a name="l00174"></a>00174                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 7;
<a name="l00175"></a>00175             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &lt; (4 &lt;&lt;4)) {
<a name="l00176"></a>00176                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 5;
<a name="l00177"></a>00177             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &gt;= ((<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 4) &lt;&lt;4)) {
<a name="l00178"></a>00178                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 1;
<a name="l00179"></a>00179             } <span class="keywordflow">else</span> {
<a name="l00180"></a>00180                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 3;
<a name="l00181"></a>00181             }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183             sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a> = sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>;
<a name="l00184"></a>00184             sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = 10;
<a name="l00185"></a>00185             sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 1;
<a name="l00186"></a>00186             <span class="keywordflow">break</span>;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a8ce060f17cd3f13f338aac493a1d90c4" title="Scary monster.">SPRITE_MONSTER</a>:
<a name="l00189"></a>00189             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 48;
<a name="l00190"></a>00190             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 48;
<a name="l00191"></a>00191             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 24;
<a name="l00192"></a>00192             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = 0;
<a name="l00193"></a>00193             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 40;
<a name="l00194"></a>00194             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = 16;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196             <span class="keywordflow">if</span> (x &gt; ((<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> &lt;&lt;4) / 2)) {
<a name="l00197"></a>00197                 <span class="keywordflow">if</span> (y &gt; ((<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> &lt;&lt;4) / 2)) {
<a name="l00198"></a>00198                     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 10;
<a name="l00199"></a>00199                 } <span class="keywordflow">else</span> {
<a name="l00200"></a>00200                     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 7;
<a name="l00201"></a>00201                 }
<a name="l00202"></a>00202             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &gt; ((<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> &lt;&lt;4) / 2)) {
<a name="l00203"></a>00203                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 1;
<a name="l00204"></a>00204             } <span class="keywordflow">else</span> {
<a name="l00205"></a>00205                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 4;
<a name="l00206"></a>00206             }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208             sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 1000;
<a name="l00209"></a>00209             sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = <a class="code" href="classMicropolis.html#75662ccbb6b1260699fba7729cd16f67" title="X coordinate of most polluted area.">pollutionMaxX</a> &lt;&lt;4;
<a name="l00210"></a>00210             sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = <a class="code" href="classMicropolis.html#5e6fd13f9ab16aa4b791ef9c9d229c53" title="Y coordinate of most polluted area.">pollutionMaxY</a> &lt;&lt;4;
<a name="l00211"></a>00211             sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a> = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>;
<a name="l00212"></a>00212             sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a> = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>;
<a name="l00213"></a>00213             <span class="keywordflow">break</span>;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a>:
<a name="l00216"></a>00216             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 32;
<a name="l00217"></a>00217             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 32;
<a name="l00218"></a>00218             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 32;
<a name="l00219"></a>00219             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = -16;
<a name="l00220"></a>00220             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 40;
<a name="l00221"></a>00221             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = -8;
<a name="l00222"></a>00222             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 5;
<a name="l00223"></a>00223             sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 1500;
<a name="l00224"></a>00224             sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>((<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> &lt;&lt;4) - 1);
<a name="l00225"></a>00225             sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>((<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> &lt;&lt;4) - 1);
<a name="l00226"></a>00226             sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a> = x - 30;
<a name="l00227"></a>00227             sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a> = y;
<a name="l00228"></a>00228             <span class="keywordflow">break</span>;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a>:
<a name="l00231"></a>00231             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 48;
<a name="l00232"></a>00232             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 48;
<a name="l00233"></a>00233             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 24;
<a name="l00234"></a>00234             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = 0;
<a name="l00235"></a>00235             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 48;
<a name="l00236"></a>00236             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = 16;
<a name="l00237"></a>00237             <span class="keywordflow">if</span> (x &gt; ((<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 20) &lt;&lt;4)) {
<a name="l00238"></a>00238                 sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> -= 100 + 48;
<a name="l00239"></a>00239                 sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> - 200;
<a name="l00240"></a>00240                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 7;
<a name="l00241"></a>00241             } <span class="keywordflow">else</span> {
<a name="l00242"></a>00242                 sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 200;
<a name="l00243"></a>00243                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 11;
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245             sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>;
<a name="l00246"></a>00246             <span class="keywordflow">break</span>;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a4a4a8673a220292b3a02bca1e886b847" title="Tornado sprite.">SPRITE_TORNADO</a>:
<a name="l00249"></a>00249             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 48;
<a name="l00250"></a>00250             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 48;
<a name="l00251"></a>00251             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 24;
<a name="l00252"></a>00252             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = 0;
<a name="l00253"></a>00253             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 40;
<a name="l00254"></a>00254             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = 36;
<a name="l00255"></a>00255             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 1;
<a name="l00256"></a>00256             sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 200;
<a name="l00257"></a>00257             <span class="keywordflow">break</span>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab747b593d9a3e5ebf0faeb4904838bdb" title="Explosion sprite.">SPRITE_EXPLOSION</a>:
<a name="l00260"></a>00260             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 48;
<a name="l00261"></a>00261             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 48;
<a name="l00262"></a>00262             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 24;
<a name="l00263"></a>00263             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = 0;
<a name="l00264"></a>00264             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 40;
<a name="l00265"></a>00265             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = 16;
<a name="l00266"></a>00266             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 1;
<a name="l00267"></a>00267             <span class="keywordflow">break</span>;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa7d3c2d6672ee99804110a6bd1822807" title="Bus sprite.">SPRITE_BUS</a>:
<a name="l00270"></a>00270             sprite-&gt;<a class="code" href="classSimSprite.html#34436d27f4c38dfb32c315016f94fb4f">width</a> = 32;
<a name="l00271"></a>00271             sprite-&gt;<a class="code" href="classSimSprite.html#b756f9fed856c969b8fca308f997ac46">height</a> = 32;
<a name="l00272"></a>00272             sprite-&gt;<a class="code" href="classSimSprite.html#d6a8181936ec3445e3ee114d6a673cae">xOffset</a> = 30;
<a name="l00273"></a>00273             sprite-&gt;<a class="code" href="classSimSprite.html#78b587ad42d3ee790f302addfb7ba16c">yOffset</a> = -18;
<a name="l00274"></a>00274             sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> = 40;
<a name="l00275"></a>00275             sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> = -8;
<a name="l00276"></a>00276             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 1;
<a name="l00277"></a>00277             sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = 1;
<a name="l00278"></a>00278             <span class="keywordflow">break</span>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00288"></a><a class="code" href="classMicropolis.html#a3da67626c49a266b9349dacccaafefc">00288</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#a3da67626c49a266b9349dacccaafefc">Micropolis::destroyAllSprites</a>()
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290     <a class="code" href="classSimSprite.html">SimSprite</a> *sprite;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="keywordflow">for</span> (sprite = <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>; sprite != NULL; sprite = sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>) {
<a name="l00293"></a>00293         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 
<a name="l00303"></a><a class="code" href="classMicropolis.html#3fe1ccc95da98b98f8ef5ac3725bc663">00303</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#3fe1ccc95da98b98f8ef5ac3725bc663">Micropolis::destroySprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305     <a class="code" href="classSimSprite.html">SimSprite</a> **sp;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (globalSprites[sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a>] == sprite) {
<a name="l00308"></a>00308         globalSprites[sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a>] = (<a class="code" href="classSimSprite.html">SimSprite</a> *)NULL;
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#00009c29518d182f8562608c62e9d4b9" title="Name of the sprite.">name</a> != NULL) {
<a name="l00312"></a>00312         <a class="code" href="classMicropolis.html#d36c964c0954aac11e20512c8ccd3c84">freePtr</a>(sprite-&gt;<a class="code" href="classSimSprite.html#00009c29518d182f8562608c62e9d4b9" title="Name of the sprite.">name</a>);
<a name="l00313"></a>00313         sprite-&gt;<a class="code" href="classSimSprite.html#00009c29518d182f8562608c62e9d4b9" title="Name of the sprite.">name</a> = NULL;
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="keywordflow">for</span> (sp = &amp;<a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>; *sp != NULL; sp = &amp;((*sp)-&gt;next)) {
<a name="l00317"></a>00317         <span class="keywordflow">if</span> (sprite == (*sp)) {
<a name="l00318"></a>00318             *sp = sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>;
<a name="l00319"></a>00319             <span class="keywordflow">break</span>;
<a name="l00320"></a>00320         }
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a> = <a class="code" href="classMicropolis.html#48947512d497950ae91b99914b83f1e2" title="Pool of free SimSprite objects.">freeSprites</a>;
<a name="l00324"></a>00324     <a class="code" href="classMicropolis.html#48947512d497950ae91b99914b83f1e2" title="Pool of free SimSprite objects.">freeSprites</a> = sprite;
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00333"></a><a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">00333</a> <a class="code" href="classSimSprite.html">SimSprite</a> *<a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">Micropolis::getSprite</a>(<span class="keywordtype">int</span> type)
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335     <a class="code" href="classSimSprite.html">SimSprite</a> *sprite = globalSprites[type];
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (sprite == NULL || sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> == 0) {
<a name="l00337"></a>00337         <span class="keywordflow">return</span> (<a class="code" href="classSimSprite.html">SimSprite</a> *)NULL;
<a name="l00338"></a>00338     } <span class="keywordflow">else</span> {
<a name="l00339"></a>00339         <span class="keywordflow">return</span> sprite;
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 
<a name="l00350"></a><a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">00350</a> <a class="code" href="classSimSprite.html">SimSprite</a> *<a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">Micropolis::makeSprite</a>(<span class="keywordtype">int</span> type, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l00351"></a>00351 {
<a name="l00352"></a>00352     <a class="code" href="classSimSprite.html">SimSprite</a> *sprite;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     sprite = globalSprites[type];
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (sprite == NULL) {
<a name="l00356"></a>00356         sprite = <a class="code" href="classMicropolis.html#c704db0c9cdd214f77e69f58e4717d65">newSprite</a>(<span class="stringliteral">""</span>, type, x, y);
<a name="l00357"></a>00357     } <span class="keywordflow">else</span> {
<a name="l00358"></a>00358         <a class="code" href="classMicropolis.html#234d173bdcc0780c131daf8be911e5e9">initSprite</a>(sprite, x, y);
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360     <span class="keywordflow">return</span> sprite;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 
<a name="l00370"></a><a class="code" href="classMicropolis.html#ba10028c93a44c1c2d462e2812380415">00370</a> <span class="keywordtype">short</span> <a class="code" href="classMicropolis.html#ba10028c93a44c1c2d462e2812380415">Micropolis::getChar</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l00371"></a>00371 {
<a name="l00372"></a>00372     <span class="comment">// Convert sprite coordinates to tile coordinates.</span>
<a name="l00373"></a>00373     x &gt;&gt;= 4;
<a name="l00374"></a>00374     y &gt;&gt;= 4;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (!<a class="code" href="classMicropolis.html#c88ae46202ab81120718c9f079d2dbfa">testBounds</a>(x, y)) {
<a name="l00377"></a>00377         <span class="keywordflow">return</span> -1;
<a name="l00378"></a>00378     } <span class="keywordflow">else</span> {
<a name="l00379"></a>00379         <span class="keywordflow">return</span> <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf424839a505f5307c64ce70cb21d88b9766" title="Mask for the MapTileCharacters part of the tile.">LOMASK</a>;
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 
<a name="l00391"></a><a class="code" href="classMicropolis.html#205e3b7c717aac7b5a628ab514dd17e7">00391</a> <span class="keywordtype">short</span> <a class="code" href="classMicropolis.html#205e3b7c717aac7b5a628ab514dd17e7">Micropolis::turnTo</a>(<span class="keywordtype">int</span> p, <span class="keywordtype">int</span> d)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393     <span class="keywordflow">if</span> (p == d) {
<a name="l00394"></a>00394         <span class="keywordflow">return</span> p;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="keywordflow">if</span> (p &lt; d) {
<a name="l00398"></a>00398         <span class="keywordflow">if</span> (d - p &lt; 4) {
<a name="l00399"></a>00399             p++;
<a name="l00400"></a>00400         } <span class="keywordflow">else</span> {
<a name="l00401"></a>00401             p--;
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403     } <span class="keywordflow">else</span> {
<a name="l00404"></a>00404         <span class="keywordflow">if</span> (p - d &lt; 4) {
<a name="l00405"></a>00405             p--;
<a name="l00406"></a>00406         } <span class="keywordflow">else</span> {
<a name="l00407"></a>00407             p++;
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="keywordflow">if</span> (p &gt; 8) {
<a name="l00412"></a>00412         p = 1;
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (p &lt; 1) {
<a name="l00416"></a>00416         p = 8;
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="keywordflow">return</span> p;
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00426"></a><a class="code" href="classMicropolis.html#94a699f39d58aef4237e41e32e6a9921">00426</a> <span class="keywordtype">bool</span> <a class="code" href="classMicropolis.html#94a699f39d58aef4237e41e32e6a9921">Micropolis::tryOther</a>(<span class="keywordtype">int</span> Tpoo, <span class="keywordtype">int</span> Told, <span class="keywordtype">int</span> Tnew)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428     <span class="keywordtype">short</span> z;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     z = Told + 4;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="keywordflow">if</span> (z &gt; 8) {
<a name="l00433"></a>00433         z -= 8;
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (Tnew != z) {
<a name="l00437"></a>00437         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="keywordflow">if</span> (Tpoo == POWERBASE || Tpoo == POWERBASE + 1
<a name="l00441"></a>00441           || Tpoo == RAILBASE || Tpoo == RAILBASE + 1) {
<a name="l00442"></a>00442         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 
<a name="l00454"></a><a class="code" href="classMicropolis.html#e9c63742971b513e121e467a10835abb">00454</a> <span class="keywordtype">bool</span> <a class="code" href="classMicropolis.html#e9c63742971b513e121e467a10835abb">Micropolis::spriteNotInBounds</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456     <span class="keywordtype">int</span> x = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>;
<a name="l00457"></a>00457     <span class="keywordtype">int</span> y = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="keywordflow">return</span> x &lt; 0 || y &lt; 0 || x &gt;= (WORLD_W &lt;&lt;4) || y &gt;= (<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> &lt;&lt;4);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00472"></a><a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">00472</a> <span class="keywordtype">short</span> <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">Micropolis::getDir</a>(<span class="keywordtype">int</span> orgX, <span class="keywordtype">int</span> orgY, <span class="keywordtype">int</span> desX, <span class="keywordtype">int</span> desY)
<a name="l00473"></a>00473 {
<a name="l00474"></a>00474     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Gdtab[13] = { 0, 3, 2, 1, 3, 4, 5, 7, 6, 5, 7, 8, 1 };
<a name="l00475"></a>00475     <span class="keywordtype">int</span> dispX, dispY, z;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     dispX = desX - orgX;
<a name="l00478"></a>00478     dispY = desY - orgY;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <span class="keywordflow">if</span> (dispX &lt; 0) {
<a name="l00481"></a>00481         <span class="keywordflow">if</span> (dispY &lt; 0) {
<a name="l00482"></a>00482             z = 11;
<a name="l00483"></a>00483         } <span class="keywordflow">else</span> {
<a name="l00484"></a>00484             z = 8;
<a name="l00485"></a>00485         }
<a name="l00486"></a>00486     } <span class="keywordflow">else</span> {
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (dispY &lt; 0) {
<a name="l00488"></a>00488             z = 2;
<a name="l00489"></a>00489         } <span class="keywordflow">else</span> {
<a name="l00490"></a>00490             z = 5;
<a name="l00491"></a>00491         }
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     dispX = <a class="code" href="micropolis_8h.html#71af18974f6f401b618926b53c00b802">absoluteValue</a>(dispX);
<a name="l00495"></a>00495     dispY = <a class="code" href="micropolis_8h.html#71af18974f6f401b618926b53c00b802">absoluteValue</a>(dispY);
<a name="l00496"></a>00496     absDist = dispX + dispY;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="keywordflow">if</span> (dispX * 2 &lt; dispY) {
<a name="l00499"></a>00499         z++;
<a name="l00500"></a>00500     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dispY * 2 &lt; dispY) {  <span class="comment">// XXX This never holds!!</span>
<a name="l00501"></a>00501         z--;
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="keywordflow">if</span> (z &lt; 0 || z &gt; 12) {
<a name="l00505"></a>00505         z = 0;
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <span class="keywordflow">return</span> Gdtab[z];
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 
<a name="l00520"></a><a class="code" href="classMicropolis.html#98e5158b4fa233b25461167c46b6beeb">00520</a> <span class="keywordtype">int</span> <a class="code" href="classMicropolis.html#98e5158b4fa233b25461167c46b6beeb">Micropolis::getDistance</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2)
<a name="l00521"></a>00521 {
<a name="l00522"></a>00522     <span class="keywordflow">return</span> <a class="code" href="micropolis_8h.html#71af18974f6f401b618926b53c00b802">absoluteValue</a>(x1 - x2) + <a class="code" href="micropolis_8h.html#71af18974f6f401b618926b53c00b802">absoluteValue</a>(y1 - y2);
<a name="l00523"></a>00523 }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525 
<a name="l00532"></a><a class="code" href="classMicropolis.html#18cf1ce85bfc2ff40802b4c0a80dc754">00532</a> <span class="keywordtype">bool</span> <a class="code" href="classMicropolis.html#18cf1ce85bfc2ff40802b4c0a80dc754">Micropolis::checkSpriteCollision</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *s1, <a class="code" href="classSimSprite.html">SimSprite</a> *s2)
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534     <span class="keywordflow">return</span> s1-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> != 0 &amp;&amp; s2-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> != 0 &amp;&amp;
<a name="l00535"></a>00535            <a class="code" href="classMicropolis.html#98e5158b4fa233b25461167c46b6beeb">getDistance</a>(s1-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + s1-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>, s1-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + s1-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>,
<a name="l00536"></a>00536                        s2-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + s2-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>, s2-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + s2-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>) &lt; 30;
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 
<a name="l00548"></a><a class="code" href="classMicropolis.html#5f68de29ebe8f2a61ae9635006ec4538">00548</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#5f68de29ebe8f2a61ae9635006ec4538">Micropolis::moveObjects</a>()
<a name="l00549"></a>00549 {
<a name="l00550"></a>00550     <a class="code" href="classSimSprite.html">SimSprite</a> *sprite;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (!simSpeed) {
<a name="l00553"></a>00553         <span class="keywordflow">return</span>;
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     spriteCycle++;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="keywordflow">for</span> (sprite = <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>; sprite != NULL;) {
<a name="l00559"></a>00559         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> &gt; 0) {
<a name="l00560"></a>00560             <span class="keywordflow">switch</span> (sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a>) {
<a name="l00561"></a>00561 
<a name="l00562"></a>00562                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a>:
<a name="l00563"></a>00563                     <a class="code" href="classMicropolis.html#8fc26778370ff4b58b77adad56dbd162">doTrainSprite</a>(sprite);
<a name="l00564"></a>00564                     <span class="keywordflow">break</span>;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a>:
<a name="l00567"></a>00567                     <a class="code" href="classMicropolis.html#01ae28d41bcf30b1e1ae8f028571a64c">doCopterSprite</a>(sprite);
<a name="l00568"></a>00568                     <span class="keywordflow">break</span>;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a>:
<a name="l00571"></a>00571                     <a class="code" href="classMicropolis.html#0992ddd3e88bf0cc80cec6738d514858">doAirplaneSprite</a>(sprite);
<a name="l00572"></a>00572                     <span class="keywordflow">break</span>;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab6ba5d8c2fd181feca500a46b00ef860" title="Ship.">SPRITE_SHIP</a>:
<a name="l00575"></a>00575                     <a class="code" href="classMicropolis.html#776ba80a037de9e09e2b2428b6ca140f">doShipSprite</a>(sprite);
<a name="l00576"></a>00576                     <span class="keywordflow">break</span>;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a8ce060f17cd3f13f338aac493a1d90c4" title="Scary monster.">SPRITE_MONSTER</a>:
<a name="l00579"></a>00579                     <a class="code" href="classMicropolis.html#cca73edb22102ee8eb2d6aa7552d65bf">doMonsterSprite</a>(sprite);
<a name="l00580"></a>00580                     <span class="keywordflow">break</span>;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a4a4a8673a220292b3a02bca1e886b847" title="Tornado sprite.">SPRITE_TORNADO</a>:
<a name="l00583"></a>00583                     <a class="code" href="classMicropolis.html#0796e3cf542f474484a74897f27d6a89">doTornadoSprite</a>(sprite);
<a name="l00584"></a>00584                     <span class="keywordflow">break</span>;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab747b593d9a3e5ebf0faeb4904838bdb" title="Explosion sprite.">SPRITE_EXPLOSION</a>:
<a name="l00587"></a>00587                     <a class="code" href="classMicropolis.html#80f5bb5c1a524fada8c92d23b55e151d">doExplosionSprite</a>(sprite);
<a name="l00588"></a>00588                     <span class="keywordflow">break</span>;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590                 <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa7d3c2d6672ee99804110a6bd1822807" title="Bus sprite.">SPRITE_BUS</a>:
<a name="l00591"></a>00591                     <a class="code" href="classMicropolis.html#aa91cb8b64a824f87937223208ea2e5e">doBusSprite</a>(sprite);
<a name="l00592"></a>00592                     <span class="keywordflow">break</span>;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594             }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596             sprite = sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         } <span class="keywordflow">else</span> {
<a name="l00599"></a>00599 
<a name="l00600"></a>00600             <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#00009c29518d182f8562608c62e9d4b9" title="Name of the sprite.">name</a>[0] == <span class="charliteral">'\0'</span>) {
<a name="l00601"></a>00601                 <a class="code" href="classSimSprite.html">SimSprite</a> *s = sprite;
<a name="l00602"></a>00602                 sprite = sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>;
<a name="l00603"></a>00603                 <a class="code" href="classMicropolis.html#3fe1ccc95da98b98f8ef5ac3725bc663">destroySprite</a>(s);
<a name="l00604"></a>00604             } <span class="keywordflow">else</span> {
<a name="l00605"></a>00605                 sprite = sprite-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>;
<a name="l00606"></a>00606             }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 
<a name="l00618"></a><a class="code" href="classMicropolis.html#8fc26778370ff4b58b77adad56dbd162">00618</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#8fc26778370ff4b58b77adad56dbd162">Micropolis::doTrainSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620     <span class="comment">/* Offset in pixels of sprite x and y to map tile */</span>
<a name="l00621"></a>00621     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Cx[4] = {   0,  16,   0, -16 };
<a name="l00622"></a>00622     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Cy[4] = { -16,   0,  16,   0 };
<a name="l00623"></a>00623     <span class="comment">/* X and Y movement of the sprite in pixels */</span>
<a name="l00624"></a>00624     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Dx[5] = {   0,   4,   0,  -4,   0 };
<a name="l00625"></a>00625     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Dy[5] = {  -4,   0,   4,   0,   0 };
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> TrainPic2[5] = { 1, 2, 1, 2, 5 };
<a name="l00628"></a>00628     <span class="keywordtype">short</span> z, dir, dir2;
<a name="l00629"></a>00629     <span class="keywordtype">short</span> c;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> == 3 || sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> == 4) {
<a name="l00632"></a>00632         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = TrainPic2[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>];
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> += Dx[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>];
<a name="l00636"></a>00636     sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> += Dy[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>];
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     <span class="keywordflow">if</span> ((spriteCycle &amp; 3) == 0) {
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         dir = <a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 3;
<a name="l00641"></a>00641         <span class="keywordflow">for</span> (z = dir; z &lt; dir + 4; z++) {
<a name="l00642"></a>00642             dir2 = z &amp; 3;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644             <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> != 4) {
<a name="l00645"></a>00645                 <span class="keywordflow">if</span> (dir2 == ((sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> + 2) &amp; 3)) {
<a name="l00646"></a>00646                     <span class="keywordflow">continue</span>;
<a name="l00647"></a>00647                 }
<a name="l00648"></a>00648             }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650             c = <a class="code" href="classMicropolis.html#ba10028c93a44c1c2d462e2812380415">getChar</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + Cx[dir2] + 48, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + Cy[dir2]);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652             <span class="keywordflow">if</span> ((c &gt;= RAILBASE &amp;&amp; c &lt;= LASTRAIL) <span class="comment">/* track? */</span>
<a name="l00653"></a>00653                       || c == <a class="code" href="micropolis_8h.html#25ebd6c017a806d6cc704d20f857443edb0a62d6e6f6e7d0d71eb8683f3e6643" title="Vertical rail, horizontal power.">RAILVPOWERH</a> || c == <a class="code" href="micropolis_8h.html#25ebd6c017a806d6cc704d20f857443e2d68d4a0bc834d379e6c00435cdb5dea" title="Horizontal rail, vertical power.">RAILHPOWERV</a>) {
<a name="l00654"></a>00654 
<a name="l00655"></a>00655                 <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> != dir2 &amp;&amp; sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> != 4) {
<a name="l00656"></a>00656 
<a name="l00657"></a>00657                     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> + dir2 == 3) {
<a name="l00658"></a>00658                         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 3;
<a name="l00659"></a>00659                     } <span class="keywordflow">else</span> {
<a name="l00660"></a>00660                         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 4;
<a name="l00661"></a>00661                     }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663                 } <span class="keywordflow">else</span> {
<a name="l00664"></a>00664                     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = TrainPic2[dir2];
<a name="l00665"></a>00665                 }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667                 <span class="keywordflow">if</span> (c == HRAIL || c == VRAIL) {
<a name="l00668"></a>00668                     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 5;
<a name="l00669"></a>00669                 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671                 sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = dir2;
<a name="l00672"></a>00672                 <span class="keywordflow">return</span>;
<a name="l00673"></a>00673             }
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> == 4) {
<a name="l00677"></a>00677             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l00678"></a>00678             <span class="keywordflow">return</span>;
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = 4;
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00690"></a><a class="code" href="classMicropolis.html#01ae28d41bcf30b1e1ae8f028571a64c">00690</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#01ae28d41bcf30b1e1ae8f028571a64c">Micropolis::doCopterSprite</a>(
<a name="l00691"></a>00691   <a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> CDx[9] = { 0,  0,  3,  5,  3,  0, -3, -5, -3 };
<a name="l00694"></a>00694     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> CDy[9] = { 0, -5, -3,  0,  3,  5,  3,  0, -3 };
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> &gt; 0) {
<a name="l00697"></a>00697         sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a>--;
<a name="l00698"></a>00698     }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a> &lt; 0) {
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> &gt; 0) {
<a name="l00703"></a>00703             sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a>--;
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> == 0) {
<a name="l00707"></a>00707 
<a name="l00708"></a>00708             <span class="comment">/* Attract copter to monster so it blows up more often */</span>
<a name="l00709"></a>00709             <a class="code" href="classSimSprite.html">SimSprite</a> *s = <a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a8ce060f17cd3f13f338aac493a1d90c4" title="Scary monster.">SPRITE_MONSTER</a>);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711             <span class="keywordflow">if</span> (s != NULL) {
<a name="l00712"></a>00712                 sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = s-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>;
<a name="l00713"></a>00713                 sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = s-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>;
<a name="l00714"></a>00714             } <span class="keywordflow">else</span> {
<a name="l00715"></a>00715 
<a name="l00716"></a>00716                 <span class="comment">/* Attract copter to tornado so it blows up more often */</span>
<a name="l00717"></a>00717                 s = <a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a4a4a8673a220292b3a02bca1e886b847" title="Tornado sprite.">SPRITE_TORNADO</a>);
<a name="l00718"></a>00718 
<a name="l00719"></a>00719                 <span class="keywordflow">if</span> (s != NULL) {
<a name="l00720"></a>00720                     sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = s-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>;
<a name="l00721"></a>00721                     sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = s-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>;
<a name="l00722"></a>00722                 } <span class="keywordflow">else</span> {
<a name="l00723"></a>00723                     sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a>;
<a name="l00724"></a>00724                     sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a>;
<a name="l00725"></a>00725                 }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727             }
<a name="l00728"></a>00728         }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> == 0) { <span class="comment">/* land */</span>
<a name="l00731"></a>00731             <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">getDir</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>, sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a>, sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a>);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733             <span class="keywordflow">if</span> (absDist &lt; 30) {
<a name="l00734"></a>00734                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l00735"></a>00735                 <span class="keywordflow">return</span>;
<a name="l00736"></a>00736             }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738         }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     } <span class="keywordflow">else</span> {
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">getDir</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>, sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a>, sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a>);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         <span class="keywordflow">if</span> (absDist &lt; 16) {
<a name="l00745"></a>00745             sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a>;
<a name="l00746"></a>00746             sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a>;
<a name="l00747"></a>00747             sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a> = -1;
<a name="l00748"></a>00748         }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> == 0) { <span class="comment">/* send report  */</span>
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <span class="comment">// Convert sprite coordinates to world coordinates.</span>
<a name="l00755"></a>00755         <span class="keywordtype">short</span> x = (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48) / 16;
<a name="l00756"></a>00756         <span class="keywordtype">short</span> y = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> / 16;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758         <span class="keywordflow">if</span> (x &gt;= 0 &amp;&amp; x &lt; WORLD_W &amp;&amp; y &gt;= 0 &amp;&amp; y &lt; <a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a>) {
<a name="l00759"></a>00759 
<a name="l00760"></a>00760             <span class="comment">/* Don changed from 160 to 170 to shut the #$%#$% thing up! */</span>
<a name="l00761"></a>00761 
<a name="l00762"></a>00762             <span class="keywordtype">int</span> chopperX = x + 1;
<a name="l00763"></a>00763             <span class="keywordtype">int</span> chopperY = y + 1;
<a name="l00764"></a>00764             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#bbcdc5868df96b13375d8732aaadaf70" title="Traffic density map.">trafficDensityMap</a>.worldGet(x, y) &gt; 170 &amp;&amp; (<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 7) == 0) {
<a name="l00765"></a>00765                 <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca820878ba1783d729d64d2c9f0e3705b7247" title="Heavy Traffic reported.">MESSAGE_HEAVY_TRAFFIC</a>, chopperX, chopperY, <span class="keyword">true</span>);
<a name="l00766"></a>00766                 <a class="code" href="classMicropolis.html#a415366f5d827b0ed7a6c458f9704e2e">makeSound</a>(<span class="stringliteral">"city"</span>, <span class="stringliteral">"HeavyTraffic"</span>, chopperX, chopperY); <span class="comment">/* chopper */</span>
<a name="l00767"></a>00767                 sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> = 200;
<a name="l00768"></a>00768             }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     <span class="keywordtype">short</span> z = sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <span class="keywordflow">if</span> ((spriteCycle &amp; 3) == 0) {
<a name="l00777"></a>00777         <span class="keywordtype">short</span> d = <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">getDir</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>, sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a>, sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a>);
<a name="l00778"></a>00778         z = <a class="code" href="classMicropolis.html#205e3b7c717aac7b5a628ab514dd17e7">turnTo</a>(z, d);
<a name="l00779"></a>00779         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = z;
<a name="l00780"></a>00780     }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> += CDx[z];
<a name="l00783"></a>00783     sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> += CDy[z];
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 
<a name="l00795"></a><a class="code" href="classMicropolis.html#0992ddd3e88bf0cc80cec6738d514858">00795</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#0992ddd3e88bf0cc80cec6738d514858">Micropolis::doAirplaneSprite</a>(
<a name="l00796"></a>00796   <a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> CDx[12] = { 0,  0,  6, 8, 6, 0, -6, -8, -6, 8, 8, 8 };
<a name="l00799"></a>00799     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> CDy[12] = { 0, -8, -6, 0, 6, 8,  6,  0, -6, 0, 0, 0 };
<a name="l00800"></a>00800 
<a name="l00801"></a>00801     <span class="keywordtype">short</span> z = sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>;
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <span class="keywordflow">if</span> ((spriteCycle % 5) == 0) {
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         <span class="keywordflow">if</span> (z &gt; 8) { <span class="comment">/* TakeOff  */</span>
<a name="l00806"></a>00806             z--;
<a name="l00807"></a>00807             <span class="keywordflow">if</span> (z &lt; 9) {
<a name="l00808"></a>00808                 z = 3;
<a name="l00809"></a>00809             }
<a name="l00810"></a>00810             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = z;
<a name="l00811"></a>00811         } <span class="keywordflow">else</span> { <span class="comment">/* goto destination */</span>
<a name="l00812"></a>00812             <span class="keywordtype">short</span> d = <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">getDir</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>, sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a>, sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a>);
<a name="l00813"></a>00813             z = <a class="code" href="classMicropolis.html#205e3b7c717aac7b5a628ab514dd17e7">turnTo</a>(z, d);
<a name="l00814"></a>00814             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = z;
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="keywordflow">if</span> (absDist &lt; 50) { <span class="comment">/* at destination  */</span>
<a name="l00820"></a>00820         sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>((<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> * 16) + 100) - 50;
<a name="l00821"></a>00821         sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>((<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> * 16) + 100) - 50;
<a name="l00822"></a>00822     }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <span class="comment">/* deh added test for enableDisasters */</span>
<a name="l00825"></a>00825     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#680a0861f9870a09279c685cfd077d96" title="Enable disasters.">enableDisasters</a>) {
<a name="l00826"></a>00826         <a class="code" href="classSimSprite.html">SimSprite</a> *s;
<a name="l00827"></a>00827         <span class="keywordtype">bool</span> explode = <span class="keyword">false</span>;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829         <span class="comment">/* Check whether another sprite is near enough to collide with */</span>
<a name="l00830"></a>00830         <span class="keywordflow">for</span> (s = <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>; s != NULL; s = s-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>) {
<a name="l00831"></a>00831             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> == 0 || s == sprite) {
<a name="l00832"></a>00832                 <span class="comment">/* Non-active sprite, or self: skip */</span>
<a name="l00833"></a>00833                 <span class="keywordflow">continue</span>;
<a name="l00834"></a>00834             }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836             <span class="keywordflow">if</span> ((s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a> || s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a>)
<a name="l00837"></a>00837                                           &amp;&amp; <a class="code" href="classMicropolis.html#18cf1ce85bfc2ff40802b4c0a80dc754">checkSpriteCollision</a>(sprite, s)) {
<a name="l00838"></a>00838                 <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">explodeSprite</a>(s);
<a name="l00839"></a>00839                 explode = <span class="keyword">true</span>;
<a name="l00840"></a>00840             }
<a name="l00841"></a>00841         }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <span class="keywordflow">if</span> (explode) {
<a name="l00844"></a>00844             <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">explodeSprite</a>(sprite);
<a name="l00845"></a>00845         }
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> += CDx[z];
<a name="l00849"></a>00849     sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> += CDy[z];
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#e9c63742971b513e121e467a10835abb">spriteNotInBounds</a>(sprite)) {
<a name="l00852"></a>00852         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 
<a name="l00862"></a><a class="code" href="classMicropolis.html#776ba80a037de9e09e2b2428b6ca140f">00862</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#776ba80a037de9e09e2b2428b6ca140f">Micropolis::doShipSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> BDx[9] = { 0,  0,  1,  1,  1,  0, -1, -1, -1 };
<a name="l00865"></a>00865     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> BDy[9] = { 0, -1, -1,  0,  1,  1,  1,  0, -1 };
<a name="l00866"></a>00866     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> BPx[9] = { 0,  0,  2,  2,  2,  0, -2, -2, -2 };
<a name="l00867"></a>00867     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> BPy[9] = { 0, -2, -2,  0,  2,  2,  2,  0, -2 };
<a name="l00868"></a>00868     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> BtClrTab[8] = { RIVER, CHANNEL, POWERBASE, POWERBASE + 1,
<a name="l00869"></a>00869                                        RAILBASE, RAILBASE + 1, BRWH, BRWV };
<a name="l00870"></a>00870     <span class="keywordtype">short</span> x, y, z, t = RIVER;
<a name="l00871"></a>00871     <span class="keywordtype">short</span> tem, pem;
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> &gt; 0) {
<a name="l00874"></a>00874         sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a>--;
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <span class="keywordflow">if</span> (!sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a>) {
<a name="l00878"></a>00878 
<a name="l00879"></a>00879         <span class="keywordflow">if</span> ((<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 3) == 1) {
<a name="l00880"></a>00880 
<a name="l00881"></a>00881             <span class="comment">// Convert sprite coordinates to tile coordinates.</span>
<a name="l00882"></a>00882             <span class="keywordtype">int</span> shipX = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> &gt;&gt;4;
<a name="l00883"></a>00883             <span class="keywordtype">int</span> shipY = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> &gt;&gt;4;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#2ef685b0d3c202a6d03e62d6d745449b" title="Scenario being played.">scenario</a> == <a class="code" href="micropolis_8h.html#198c01cbf13aa7ce7b025ff7b7aba07db63927fdaa04882bb676aae27893d6a6" title="San francisco (earthquake).">SC_SAN_FRANCISCO</a> &amp;&amp; <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(10) &lt; 5) {
<a name="l00886"></a>00886                 <a class="code" href="classMicropolis.html#a415366f5d827b0ed7a6c458f9704e2e">makeSound</a>(<span class="stringliteral">"city"</span>, <span class="stringliteral">"FogHornLow"</span>, shipX, shipY);
<a name="l00887"></a>00887             } <span class="keywordflow">else</span> {
<a name="l00888"></a>00888                 <a class="code" href="classMicropolis.html#a415366f5d827b0ed7a6c458f9704e2e">makeSound</a>(<span class="stringliteral">"city"</span>, <span class="stringliteral">"HonkHonkLow"</span>, shipX, shipY);
<a name="l00889"></a>00889             }
<a name="l00890"></a>00890 
<a name="l00891"></a>00891         }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893         sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> = 200;
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> &gt; 0) {
<a name="l00897"></a>00897         sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a>--;
<a name="l00898"></a>00898     }
<a name="l00899"></a>00899 
<a name="l00900"></a>00900     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> == 0) {
<a name="l00901"></a>00901 
<a name="l00902"></a>00902         sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 9;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> != sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a>) {
<a name="l00905"></a>00905             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = <a class="code" href="classMicropolis.html#205e3b7c717aac7b5a628ab514dd17e7">turnTo</a>(sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a>);
<a name="l00906"></a>00906             <span class="keywordflow">return</span>;
<a name="l00907"></a>00907         }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909         tem = <a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 7;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911         <span class="keywordflow">for</span> (pem = tem; pem &lt; (tem + 8); pem++) {
<a name="l00912"></a>00912 
<a name="l00913"></a>00913             z = (pem &amp; 7) + 1;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915             <span class="keywordflow">if</span> (z == sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>) {
<a name="l00916"></a>00916                 <span class="keywordflow">continue</span>;
<a name="l00917"></a>00917             }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919             x = ((sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + (48 - 1)) &gt;&gt;4) + BDx[z];
<a name="l00920"></a>00920             y = (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> &gt;&gt;4) + BDy[z];
<a name="l00921"></a>00921 
<a name="l00922"></a>00922             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#c88ae46202ab81120718c9f079d2dbfa">testBounds</a>(x, y)) {
<a name="l00923"></a>00923 
<a name="l00924"></a>00924                 t = <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf424839a505f5307c64ce70cb21d88b9766" title="Mask for the MapTileCharacters part of the tile.">LOMASK</a>;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926                 <span class="keywordflow">if</span> (t == CHANNEL || t == BRWH || t == BRWV
<a name="l00927"></a>00927                                                     || <a class="code" href="classMicropolis.html#94a699f39d58aef4237e41e32e6a9921">tryOther</a>(t, sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>, z)) {
<a name="l00928"></a>00928 
<a name="l00929"></a>00929                     sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a> = z;
<a name="l00930"></a>00930                     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = <a class="code" href="classMicropolis.html#205e3b7c717aac7b5a628ab514dd17e7">turnTo</a>(sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a>);
<a name="l00931"></a>00931                     sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = z + 4;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933                     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> &gt; 8) {
<a name="l00934"></a>00934                         sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> -= 8;
<a name="l00935"></a>00935                     }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937                     <span class="keywordflow">break</span>;
<a name="l00938"></a>00938                 }
<a name="l00939"></a>00939             }
<a name="l00940"></a>00940         }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942         <span class="keywordflow">if</span> (pem == (tem + 8)) {
<a name="l00943"></a>00943             sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = 10;
<a name="l00944"></a>00944             sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a> = (<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 7) + 1;
<a name="l00945"></a>00945         }
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     } <span class="keywordflow">else</span> {
<a name="l00948"></a>00948 
<a name="l00949"></a>00949         z = sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951         <span class="keywordflow">if</span> (z == sprite-&gt;<a class="code" href="classSimSprite.html#e818db9cb64543fe46c8c31df184e3aa">newDir</a>)  {
<a name="l00952"></a>00952             sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> += BPx[z];
<a name="l00953"></a>00953             sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> += BPy[z];
<a name="l00954"></a>00954         }
<a name="l00955"></a>00955     }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#e9c63742971b513e121e467a10835abb">spriteNotInBounds</a>(sprite)) {
<a name="l00958"></a>00958         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l00959"></a>00959         <span class="keywordflow">return</span>;
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962     <span class="keywordflow">for</span> (z = 0; z &lt; 8; z++) {
<a name="l00963"></a>00963 
<a name="l00964"></a>00964         <span class="keywordflow">if</span> (t == BtClrTab[z]) {
<a name="l00965"></a>00965             <span class="keywordflow">break</span>;
<a name="l00966"></a>00966         }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968         <span class="keywordflow">if</span> (z == 7) {
<a name="l00969"></a>00969             <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">explodeSprite</a>(sprite);
<a name="l00970"></a>00970             <a class="code" href="classMicropolis.html#f8e90c53f354cae1aee048cddcd9bd09">destroyMapTile</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>);
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     }
<a name="l00974"></a>00974 }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 
<a name="l01002"></a><a class="code" href="classMicropolis.html#cca73edb22102ee8eb2d6aa7552d65bf">01002</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#cca73edb22102ee8eb2d6aa7552d65bf">Micropolis::doMonsterSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l01003"></a>01003 {
<a name="l01004"></a>01004     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Gx[5] = {  2,  2, -2, -2,  0 };
<a name="l01005"></a>01005     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Gy[5] = { -2,  2,  2, -2,  0 };
<a name="l01006"></a>01006     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> ND1[4] = {  0,  1,  2,  3 };
<a name="l01007"></a>01007     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> ND2[4] = {  1,  2,  3,  0 };
<a name="l01008"></a>01008     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> nn1[4] = {  2,  5,  8, 11 };
<a name="l01009"></a>01009     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> nn2[4] = { 11,  2,  5,  8 };
<a name="l01010"></a>01010     <span class="keywordtype">short</span> d, z, c;
<a name="l01011"></a>01011 
<a name="l01012"></a>01012     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> &gt; 0) {
<a name="l01013"></a>01013         sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a>--;
<a name="l01014"></a>01014     }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a> &lt; 0) {
<a name="l01017"></a>01017         <span class="comment">/* business as usual */</span>
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a> == -2) {
<a name="l01020"></a>01020 
<a name="l01021"></a>01021             d = (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> - 1) / 3;
<a name="l01022"></a>01022             z = (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> - 1) % 3;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024             <span class="keywordflow">if</span> (z == 2) {
<a name="l01025"></a>01025                 sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a> = 0;
<a name="l01026"></a>01026             }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028             <span class="keywordflow">if</span> (z == 0) {
<a name="l01029"></a>01029                 sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a> = 1;
<a name="l01030"></a>01030             }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032             <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a>) {
<a name="l01033"></a>01033                 z++;
<a name="l01034"></a>01034             } <span class="keywordflow">else</span> {
<a name="l01035"></a>01035                 z--;
<a name="l01036"></a>01036             }
<a name="l01037"></a>01037 
<a name="l01038"></a>01038             c = <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">getDir</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>, sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a>, sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a>);
<a name="l01039"></a>01039 
<a name="l01040"></a>01040             <span class="keywordflow">if</span> (absDist &lt; 18) {
<a name="l01041"></a>01041 
<a name="l01042"></a>01042                 sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a> = -1;
<a name="l01043"></a>01043                 sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 1000;
<a name="l01044"></a>01044                 sprite-&gt;<a class="code" href="classSimSprite.html#1a3ba93b6493a6fd7af4f5a9175bc2ac">flag</a> = 1;
<a name="l01045"></a>01045                 sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a>;
<a name="l01046"></a>01046                 sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a>;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048             } <span class="keywordflow">else</span> {
<a name="l01049"></a>01049 
<a name="l01050"></a>01050                 c = (c - 1) / 2;
<a name="l01051"></a>01051 
<a name="l01052"></a>01052                 <span class="keywordflow">if</span> ((c != d &amp;&amp; <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(5) == 0) || <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(20) == 0) {
<a name="l01053"></a>01053 
<a name="l01054"></a>01054                     <span class="keywordtype">int</span> diff = (c - d) &amp; 3;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056                     <span class="keywordflow">if</span> (diff == 1 || diff == 3) {
<a name="l01057"></a>01057                         d = c;
<a name="l01058"></a>01058                     } <span class="keywordflow">else</span> {
<a name="l01059"></a>01059 
<a name="l01060"></a>01060                         <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 1) {
<a name="l01061"></a>01061                             d++;
<a name="l01062"></a>01062                         } <span class="keywordflow">else</span> {
<a name="l01063"></a>01063                             d--;
<a name="l01064"></a>01064                         }
<a name="l01065"></a>01065 
<a name="l01066"></a>01066                         d &amp;= 3;
<a name="l01067"></a>01067                     }
<a name="l01068"></a>01068                 } <span class="keywordflow">else</span> {
<a name="l01069"></a>01069 
<a name="l01070"></a>01070                     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(20) == 0) {
<a name="l01071"></a>01071 
<a name="l01072"></a>01072                         <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 1) {
<a name="l01073"></a>01073                             d++;
<a name="l01074"></a>01074                         } <span class="keywordflow">else</span> {
<a name="l01075"></a>01075                             d--;
<a name="l01076"></a>01076                         }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078                         d &amp;= 3;
<a name="l01079"></a>01079                     }
<a name="l01080"></a>01080                 }
<a name="l01081"></a>01081             }
<a name="l01082"></a>01082         } <span class="keywordflow">else</span> {
<a name="l01083"></a>01083 
<a name="l01084"></a>01084             d = (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> - 1) / 3;
<a name="l01085"></a>01085 
<a name="l01086"></a>01086             <span class="keywordflow">if</span> (d &lt; 4) { <span class="comment">/* turn n s e w */</span>
<a name="l01087"></a>01087 
<a name="l01088"></a>01088                 z = (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> - 1) % 3;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090                 <span class="keywordflow">if</span> (z == 2) {
<a name="l01091"></a>01091                     sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a> = 0;
<a name="l01092"></a>01092                 }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094                 <span class="keywordflow">if</span> (z == 0) {
<a name="l01095"></a>01095                     sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a> = 1;
<a name="l01096"></a>01096                 }
<a name="l01097"></a>01097 
<a name="l01098"></a>01098                 <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a>) {
<a name="l01099"></a>01099                     z++;
<a name="l01100"></a>01100                 } <span class="keywordflow">else</span> {
<a name="l01101"></a>01101                     z--;
<a name="l01102"></a>01102                 }
<a name="l01103"></a>01103 
<a name="l01104"></a>01104                 <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">getDir</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>, sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a>, sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a>);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106                 <span class="keywordflow">if</span> (absDist &lt; 60) {
<a name="l01107"></a>01107 
<a name="l01108"></a>01108                     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#1a3ba93b6493a6fd7af4f5a9175bc2ac">flag</a> == 0) {
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                         sprite-&gt;<a class="code" href="classSimSprite.html#1a3ba93b6493a6fd7af4f5a9175bc2ac">flag</a> = 1;
<a name="l01111"></a>01111                         sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = sprite-&gt;<a class="code" href="classSimSprite.html#9597c07c78606df71fe50ffc1996ed41">origX</a>;
<a name="l01112"></a>01112                         sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = sprite-&gt;<a class="code" href="classSimSprite.html#08bfb4ec75cc2e7a714d72a1ed3f110a">origY</a>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114                     } <span class="keywordflow">else</span> {
<a name="l01115"></a>01115 
<a name="l01116"></a>01116                         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l01117"></a>01117                         <span class="keywordflow">return</span>;
<a name="l01118"></a>01118 
<a name="l01119"></a>01119                     }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121                 }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123                 c = <a class="code" href="classMicropolis.html#4929db3f8bb84bec029f7e1f99e42765">getDir</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>, sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a>, sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a>);
<a name="l01124"></a>01124                 c = (c - 1) / 2;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126                 <span class="keywordflow">if</span> ((c != d) &amp;&amp; (!<a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(10))) {
<a name="l01127"></a>01127 
<a name="l01128"></a>01128                     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 1) {
<a name="l01129"></a>01129                         z = ND1[d];
<a name="l01130"></a>01130                     } <span class="keywordflow">else</span> {
<a name="l01131"></a>01131                         z = ND2[d];
<a name="l01132"></a>01132                     }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134                     d = 4;
<a name="l01135"></a>01135 
<a name="l01136"></a>01136                     <span class="keywordflow">if</span> (!sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a>) {
<a name="l01137"></a>01137                         <span class="comment">// Convert sprite coordinates to tile coordinates.</span>
<a name="l01138"></a>01138                         <span class="keywordtype">int</span> monsterX = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> &gt;&gt;4;
<a name="l01139"></a>01139                         <span class="keywordtype">int</span> monsterY = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> &gt;&gt;4;
<a name="l01140"></a>01140                         <a class="code" href="classMicropolis.html#a415366f5d827b0ed7a6c458f9704e2e">makeSound</a>(<span class="stringliteral">"city"</span>, <span class="stringliteral">"Monster"</span>, monsterX, monsterY); <span class="comment">/* monster */</span>
<a name="l01141"></a>01141                         sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> = 50 + <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(100);
<a name="l01142"></a>01142                     }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144                 }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146             } <span class="keywordflow">else</span> {
<a name="l01147"></a>01147 
<a name="l01148"></a>01148                 d = 4;
<a name="l01149"></a>01149                 c = sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>;
<a name="l01150"></a>01150                 z = (c - 13) &amp; 3;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152                 <span class="keywordflow">if</span> (!(<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 3)) {
<a name="l01153"></a>01153 
<a name="l01154"></a>01154                     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 1) {
<a name="l01155"></a>01155                         z = nn1[z];
<a name="l01156"></a>01156                     } <span class="keywordflow">else</span> {
<a name="l01157"></a>01157                         z = nn2[z];
<a name="l01158"></a>01158                     }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160                     d = (z - 1) / 3;
<a name="l01161"></a>01161                     z = (z - 1) % 3;
<a name="l01162"></a>01162 
<a name="l01163"></a>01163                 }
<a name="l01164"></a>01164 
<a name="l01165"></a>01165             }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167         }
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     } <span class="keywordflow">else</span> {
<a name="l01170"></a>01170 
<a name="l01171"></a>01171           <span class="comment">/* somebody's taken control of the monster */</span>
<a name="l01172"></a>01172 
<a name="l01173"></a>01173           d = sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a>;
<a name="l01174"></a>01174           z = (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> - 1) % 3;
<a name="l01175"></a>01175 
<a name="l01176"></a>01176           <span class="keywordflow">if</span> (z == 2) {
<a name="l01177"></a>01177               sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a> = 0;
<a name="l01178"></a>01178           }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180           <span class="keywordflow">if</span> (z == 0) {
<a name="l01181"></a>01181               sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a> = 1;
<a name="l01182"></a>01182           }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184           <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#ce7bed0a23828267b6230a3fce8daff0">step</a>) {
<a name="l01185"></a>01185               z++;
<a name="l01186"></a>01186           } <span class="keywordflow">else</span> {
<a name="l01187"></a>01187               z--;
<a name="l01188"></a>01188           }
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     z = d * 3 + z + 1;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     <span class="keywordflow">if</span> (z &gt; 16) {
<a name="l01195"></a>01195         z = 16;
<a name="l01196"></a>01196     }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = z;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200     sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> += Gx[d];
<a name="l01201"></a>01201     sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> += Gy[d];
<a name="l01202"></a>01202 
<a name="l01203"></a>01203     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> &gt; 0) {
<a name="l01204"></a>01204         sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a>--;
<a name="l01205"></a>01205     }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     c = <a class="code" href="classMicropolis.html#ba10028c93a44c1c2d462e2812380415">getChar</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>);
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="keywordflow">if</span> (c == -1
<a name="l01210"></a>01210           || (c == RIVER &amp;&amp; sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> != 0 &amp;&amp; sprite-&gt;<a class="code" href="classSimSprite.html#41c2753edd8414a4865deab98956cbea">control</a> == -1)) {
<a name="l01211"></a>01211         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0; <span class="comment">/* kill scary monster */</span>
<a name="l01212"></a>01212     }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     {
<a name="l01215"></a>01215         <a class="code" href="classSimSprite.html">SimSprite</a> *s;
<a name="l01216"></a>01216         <span class="keywordflow">for</span> (s = <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>; s != NULL; s = s-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>) {
<a name="l01217"></a>01217             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> != 0 &amp;&amp;
<a name="l01218"></a>01218                 (s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a> || s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a>
<a name="l01219"></a>01219                  || s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab6ba5d8c2fd181feca500a46b00ef860" title="Ship.">SPRITE_SHIP</a> || s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a>) &amp;&amp;
<a name="l01220"></a>01220                 <a class="code" href="classMicropolis.html#18cf1ce85bfc2ff40802b4c0a80dc754">checkSpriteCollision</a>(sprite, s)) {
<a name="l01221"></a>01221                 <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">explodeSprite</a>(s);
<a name="l01222"></a>01222             }
<a name="l01223"></a>01223         }
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226     <a class="code" href="classMicropolis.html#f8e90c53f354cae1aee048cddcd9bd09">destroyMapTile</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + 16);
<a name="l01227"></a>01227 }
<a name="l01228"></a>01228 
<a name="l01234"></a><a class="code" href="classMicropolis.html#0796e3cf542f474484a74897f27d6a89">01234</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#0796e3cf542f474484a74897f27d6a89">Micropolis::doTornadoSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l01235"></a>01235 {
<a name="l01236"></a>01236     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> CDx[9] = {  2,  3,  2,  0, -2, -3 };
<a name="l01237"></a>01237     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> CDy[9] = { -2,  0,  2,  3,  2,  0 };
<a name="l01238"></a>01238     <span class="keyword">register</span> <span class="keywordtype">short</span> z;
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     z = sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>;
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (z == 2) {
<a name="l01243"></a>01243 
<a name="l01244"></a>01244         <span class="comment">/* cycle animation... post Rel */</span>
<a name="l01245"></a>01245 
<a name="l01246"></a>01246         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#1a3ba93b6493a6fd7af4f5a9175bc2ac">flag</a>) {
<a name="l01247"></a>01247             z = 3;
<a name="l01248"></a>01248         } <span class="keywordflow">else</span> {
<a name="l01249"></a>01249             z = 1;
<a name="l01250"></a>01250         }
<a name="l01251"></a>01251 
<a name="l01252"></a>01252     } <span class="keywordflow">else</span> {
<a name="l01253"></a>01253 
<a name="l01254"></a>01254         <span class="keywordflow">if</span> (z == 1) {
<a name="l01255"></a>01255             sprite-&gt;<a class="code" href="classSimSprite.html#1a3ba93b6493a6fd7af4f5a9175bc2ac">flag</a> = 1;
<a name="l01256"></a>01256         } <span class="keywordflow">else</span> {
<a name="l01257"></a>01257             sprite-&gt;<a class="code" href="classSimSprite.html#1a3ba93b6493a6fd7af4f5a9175bc2ac">flag</a> = 0;
<a name="l01258"></a>01258         }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260         z = 2;
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> &gt; 0) {
<a name="l01264"></a>01264         sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a>--;
<a name="l01265"></a>01265     }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = z;
<a name="l01268"></a>01268 
<a name="l01269"></a>01269     {
<a name="l01270"></a>01270         <a class="code" href="classSimSprite.html">SimSprite</a> *s;
<a name="l01271"></a>01271         <span class="keywordflow">for</span> (s = <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>; s != NULL; s = s-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>) {
<a name="l01272"></a>01272             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> != 0 &amp;&amp;
<a name="l01273"></a>01273                 (s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a> || s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a>
<a name="l01274"></a>01274                  || s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab6ba5d8c2fd181feca500a46b00ef860" title="Ship.">SPRITE_SHIP</a> || s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a>) &amp;&amp;
<a name="l01275"></a>01275                 <a class="code" href="classMicropolis.html#18cf1ce85bfc2ff40802b4c0a80dc754">checkSpriteCollision</a>(sprite, s)) {
<a name="l01276"></a>01276                 <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">explodeSprite</a>(s);
<a name="l01277"></a>01277             }
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279     }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     z = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(5);
<a name="l01282"></a>01282     sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> += CDx[z];
<a name="l01283"></a>01283     sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> += CDy[z];
<a name="l01284"></a>01284 
<a name="l01285"></a>01285     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#e9c63742971b513e121e467a10835abb">spriteNotInBounds</a>(sprite)) {
<a name="l01286"></a>01286         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l01287"></a>01287     }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> != 0 &amp;&amp; <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(500) == 0) {
<a name="l01290"></a>01290         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l01291"></a>01291     }
<a name="l01292"></a>01292 
<a name="l01293"></a>01293     <a class="code" href="classMicropolis.html#f8e90c53f354cae1aee048cddcd9bd09">destroyMapTile</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + 40);
<a name="l01294"></a>01294 }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 
<a name="l01301"></a><a class="code" href="classMicropolis.html#80f5bb5c1a524fada8c92d23b55e151d">01301</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#80f5bb5c1a524fada8c92d23b55e151d">Micropolis::doExplosionSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l01302"></a>01302 {
<a name="l01303"></a>01303     <span class="keywordtype">short</span> x, y;
<a name="l01304"></a>01304 
<a name="l01305"></a>01305     <span class="keywordflow">if</span> ((spriteCycle &amp; 1) == 0) {
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> == 1) {
<a name="l01308"></a>01308             <span class="comment">// Convert sprite coordinates to tile coordinates.</span>
<a name="l01309"></a>01309             <span class="keywordtype">int</span> explosionX = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> &gt;&gt;4;
<a name="l01310"></a>01310             <span class="keywordtype">int</span> explosionY = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> &gt;&gt;4;
<a name="l01311"></a>01311             <a class="code" href="classMicropolis.html#a415366f5d827b0ed7a6c458f9704e2e">makeSound</a>(<span class="stringliteral">"city"</span>, <span class="stringliteral">"ExplosionHigh"</span>, explosionX, explosionY); <span class="comment">/* explosion */</span>
<a name="l01312"></a>01312             x = (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> &gt;&gt;4) + 3;
<a name="l01313"></a>01313             y = (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> &gt;&gt;4);
<a name="l01314"></a>01314             <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca8206b261d9024dee984f6a956ecf19147c5" title="Explosion detected !">MESSAGE_EXPLOSION_REPORTED</a>, x, y);
<a name="l01315"></a>01315         }
<a name="l01316"></a>01316 
<a name="l01317"></a>01317         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>++;
<a name="l01318"></a>01318     }
<a name="l01319"></a>01319 
<a name="l01320"></a>01320     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> &gt; 6) {
<a name="l01321"></a>01321         sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323         <a class="code" href="classMicropolis.html#5b7cfd94c47bd468d19fa0635691c9e0">startFire</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48 - 8, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + 16);
<a name="l01324"></a>01324         <a class="code" href="classMicropolis.html#5b7cfd94c47bd468d19fa0635691c9e0">startFire</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48 - 24, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>);
<a name="l01325"></a>01325         <a class="code" href="classMicropolis.html#5b7cfd94c47bd468d19fa0635691c9e0">startFire</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48 + 8, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a>);
<a name="l01326"></a>01326         <a class="code" href="classMicropolis.html#5b7cfd94c47bd468d19fa0635691c9e0">startFire</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48 - 24, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + 32);
<a name="l01327"></a>01327         <a class="code" href="classMicropolis.html#5b7cfd94c47bd468d19fa0635691c9e0">startFire</a>(sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + 48 + 8, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + 32);
<a name="l01328"></a>01328     }
<a name="l01329"></a>01329 }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331 
<a name="l01337"></a><a class="code" href="classMicropolis.html#aa91cb8b64a824f87937223208ea2e5e">01337</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#aa91cb8b64a824f87937223208ea2e5e">Micropolis::doBusSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l01338"></a>01338 {
<a name="l01339"></a>01339     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Dx[5] = {   0,   1,   0,  -1,   0 };
<a name="l01340"></a>01340     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Dy[5] = {  -1,   0,   1,   0,   0 };
<a name="l01341"></a>01341     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">short</span> Dir2Frame[4] = { 1, 2, 1, 2 };
<a name="l01342"></a>01342     <span class="keywordtype">int</span> dx, dy, tx, ty, otx, oty;
<a name="l01343"></a>01343     <span class="keywordtype">int</span> turned = 0;
<a name="l01344"></a>01344     <span class="keywordtype">int</span> speed = 0;
<a name="l01345"></a>01345     <span class="keywordtype">int</span> z;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01348"></a>01348 <span class="preprocessor"></span>    printf(<span class="stringliteral">"Bus dir %d turn %d frame %d\n"</span>,
<a name="l01349"></a>01349            sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>, sprite-&gt;<a class="code" href="classSimSprite.html#2752bdba73b42e8af8e139bfd08a03ba">turn</a>, sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a>);
<a name="l01350"></a>01350 <span class="preprocessor">#endif</span>
<a name="l01351"></a>01351 <span class="preprocessor"></span>
<a name="l01352"></a>01352     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#2752bdba73b42e8af8e139bfd08a03ba">turn</a>) {
<a name="l01353"></a>01353 
<a name="l01354"></a>01354         <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#2752bdba73b42e8af8e139bfd08a03ba">turn</a> &lt; 0) { <span class="comment">/* ccw */</span>
<a name="l01355"></a>01355 
<a name="l01356"></a>01356             <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> &amp; 1) { <span class="comment">/* up or down */</span>
<a name="l01357"></a>01357                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 4;
<a name="l01358"></a>01358             } <span class="keywordflow">else</span> { <span class="comment">/* left or right */</span>
<a name="l01359"></a>01359                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 3;
<a name="l01360"></a>01360             }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362             sprite-&gt;<a class="code" href="classSimSprite.html#2752bdba73b42e8af8e139bfd08a03ba">turn</a>++;
<a name="l01363"></a>01363             sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> - 1) &amp; 3;
<a name="l01364"></a>01364 
<a name="l01365"></a>01365         } <span class="keywordflow">else</span> { <span class="comment">/* cw */</span>
<a name="l01366"></a>01366 
<a name="l01367"></a>01367             <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> &amp; 1) { <span class="comment">/* up or down */</span>
<a name="l01368"></a>01368                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 3;
<a name="l01369"></a>01369             } <span class="keywordflow">else</span> { <span class="comment">/* left or right */</span>
<a name="l01370"></a>01370                 sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 4;
<a name="l01371"></a>01371             }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373             sprite-&gt;<a class="code" href="classSimSprite.html#2752bdba73b42e8af8e139bfd08a03ba">turn</a>--;
<a name="l01374"></a>01374             sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> = (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a> + 1) &amp; 3;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376         }
<a name="l01377"></a>01377 
<a name="l01378"></a>01378         turned = 1;
<a name="l01379"></a>01379 
<a name="l01380"></a>01380     } <span class="keywordflow">else</span> {
<a name="l01381"></a>01381 
<a name="l01382"></a>01382         <span class="comment">/* finish turn */</span>
<a name="l01383"></a>01383         <span class="keywordflow">if</span> ((sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> == 3) ||
<a name="l01384"></a>01384             (sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> == 4)) {
<a name="l01385"></a>01385             turned = 1;
<a name="l01386"></a>01386             sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = Dir2Frame[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>];
<a name="l01387"></a>01387         }
<a name="l01388"></a>01388     }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390     <span class="keywordflow">if</span> (sprite-&gt;<a class="code" href="classSimSprite.html#3fa74306df63340813b6e41d805d4ec9">speed</a> == 0) {
<a name="l01391"></a>01391 
<a name="l01392"></a>01392         <span class="comment">/* brake */</span>
<a name="l01393"></a>01393         dx = 0; dy = 0;
<a name="l01394"></a>01394 
<a name="l01395"></a>01395     } <span class="keywordflow">else</span> { <span class="comment">/* cruise at traffic speed */</span>
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         tx = (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>) &gt;&gt;5;
<a name="l01398"></a>01398         ty = (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>) &gt;&gt;5;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <span class="keywordflow">if</span> (tx &gt;= 0 &amp;&amp; tx &lt; WORLD_W_2 &amp;&amp; ty &gt;= 0 &amp;&amp; ty &lt; <a class="code" href="micropolis_8h.html#71ba1070fe100c29cc691f9a86d60e63">WORLD_H_2</a>) {
<a name="l01401"></a>01401 
<a name="l01402"></a>01402             z = <a class="code" href="classMicropolis.html#bbcdc5868df96b13375d8732aaadaf70" title="Traffic density map.">trafficDensityMap</a>.worldGet(tx &lt;&lt; 1, ty &lt;&lt; 1) &gt;&gt;6;
<a name="l01403"></a>01403 
<a name="l01404"></a>01404             <span class="keywordflow">if</span> (z &gt; 1) {
<a name="l01405"></a>01405                 z--;
<a name="l01406"></a>01406             }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408         } <span class="keywordflow">else</span> {
<a name="l01409"></a>01409 
<a name="l01410"></a>01410             z = 0;
<a name="l01411"></a>01411 
<a name="l01412"></a>01412         }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414         <span class="keywordflow">switch</span> (z) {
<a name="l01415"></a>01415 
<a name="l01416"></a>01416             <span class="keywordflow">case</span> 0:
<a name="l01417"></a>01417                 speed = 8;
<a name="l01418"></a>01418                 <span class="keywordflow">break</span>;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420             <span class="keywordflow">case</span> 1:
<a name="l01421"></a>01421                 speed = 4;
<a name="l01422"></a>01422                 <span class="keywordflow">break</span>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424             <span class="keywordflow">case</span> 2:
<a name="l01425"></a>01425                 speed = 1;
<a name="l01426"></a>01426                 <span class="keywordflow">break</span>;
<a name="l01427"></a>01427 
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430         <span class="comment">/* govern speed */</span>
<a name="l01431"></a>01431         <span class="keywordflow">if</span> (speed &gt; sprite-&gt;<a class="code" href="classSimSprite.html#3fa74306df63340813b6e41d805d4ec9">speed</a>) {
<a name="l01432"></a>01432             speed = sprite-&gt;<a class="code" href="classSimSprite.html#3fa74306df63340813b6e41d805d4ec9">speed</a>;
<a name="l01433"></a>01433         }
<a name="l01434"></a>01434 
<a name="l01435"></a>01435         <span class="keywordflow">if</span> (turned) {
<a name="l01436"></a>01436 
<a name="l01437"></a>01437 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01438"></a>01438 <span class="preprocessor"></span>          printf(<span class="stringliteral">"turned\n"</span>);
<a name="l01439"></a>01439 <span class="preprocessor">#endif</span>
<a name="l01440"></a>01440 <span class="preprocessor"></span>
<a name="l01441"></a>01441             <span class="keywordflow">if</span> (speed &gt; 1) {
<a name="l01442"></a>01442                 speed = 1;
<a name="l01443"></a>01443             }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445             dx = Dx[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * speed;
<a name="l01446"></a>01446             dy = Dy[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * speed;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448         } <span class="keywordflow">else</span> {
<a name="l01449"></a>01449 
<a name="l01450"></a>01450             dx = Dx[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * speed;
<a name="l01451"></a>01451             dy = Dy[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * speed;
<a name="l01452"></a>01452 
<a name="l01453"></a>01453             tx = (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>) &gt;&gt;4;
<a name="l01454"></a>01454             ty = (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>) &gt;&gt;4;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456             <span class="comment">/* drift into the right lane */</span>
<a name="l01457"></a>01457             <span class="keywordflow">switch</span> (sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>) {
<a name="l01458"></a>01458 
<a name="l01459"></a>01459                   <span class="keywordflow">case</span> 0: <span class="comment">/* up */</span>
<a name="l01460"></a>01460 
<a name="l01461"></a>01461                     z = ((tx &lt;&lt;4) + 4) - (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>);
<a name="l01462"></a>01462 
<a name="l01463"></a>01463                     <span class="keywordflow">if</span> (z &lt; 0) {
<a name="l01464"></a>01464                         dx = -1;
<a name="l01465"></a>01465                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (z &gt; 0) {
<a name="l01466"></a>01466                         dx = 1;
<a name="l01467"></a>01467                     }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01470"></a>01470 <span class="preprocessor"></span>                    printf(<span class="stringliteral">"moving up x %x z %d dx %d\n"</span>, sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>, z, dx);
<a name="l01471"></a>01471 <span class="preprocessor">#endif</span>
<a name="l01472"></a>01472 <span class="preprocessor"></span>
<a name="l01473"></a>01473                     <span class="keywordflow">break</span>;
<a name="l01474"></a>01474 
<a name="l01475"></a>01475                 <span class="keywordflow">case</span> 1: <span class="comment">/* right */</span>
<a name="l01476"></a>01476 
<a name="l01477"></a>01477                     z = ((ty &lt;&lt;4) + 4) - (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479                     <span class="keywordflow">if</span> (z &lt; 0) {
<a name="l01480"></a>01480                         dy = -1;
<a name="l01481"></a>01481                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (z &gt; 0) {
<a name="l01482"></a>01482                         dy = 1;
<a name="l01483"></a>01483                     }
<a name="l01484"></a>01484 
<a name="l01485"></a>01485 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01486"></a>01486 <span class="preprocessor"></span>                    printf(<span class="stringliteral">"moving right y %x z %d dy %d\n"</span>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>, z, dy);
<a name="l01487"></a>01487 <span class="preprocessor">#endif</span>
<a name="l01488"></a>01488 <span class="preprocessor"></span>
<a name="l01489"></a>01489                     <span class="keywordflow">break</span>;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491                 <span class="keywordflow">case</span> 2: <span class="comment">/* down */</span>
<a name="l01492"></a>01492 
<a name="l01493"></a>01493                     z = (tx &lt;&lt;4) - (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>);
<a name="l01494"></a>01494 
<a name="l01495"></a>01495                     <span class="keywordflow">if</span> (z &lt; 0) {
<a name="l01496"></a>01496                         dx = -1;
<a name="l01497"></a>01497                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (z &gt; 0) {
<a name="l01498"></a>01498                         dx = 1;
<a name="l01499"></a>01499                     }
<a name="l01500"></a>01500 
<a name="l01501"></a>01501 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01502"></a>01502 <span class="preprocessor"></span>                    printf(<span class="stringliteral">"moving down x %x z %d dx %d\n"</span>, sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>, z, dx);
<a name="l01503"></a>01503 <span class="preprocessor">#endif</span>
<a name="l01504"></a>01504 <span class="preprocessor"></span>
<a name="l01505"></a>01505                     <span class="keywordflow">break</span>;
<a name="l01506"></a>01506 
<a name="l01507"></a>01507                 <span class="keywordflow">case</span> 3: <span class="comment">/* left */</span>
<a name="l01508"></a>01508 
<a name="l01509"></a>01509                     z = (ty &lt;&lt;4) - (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>);
<a name="l01510"></a>01510 
<a name="l01511"></a>01511                     <span class="keywordflow">if</span> (z &lt; 0) {
<a name="l01512"></a>01512                         dy = -1;
<a name="l01513"></a>01513                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (z &gt; 0) {
<a name="l01514"></a>01514                         dy = 1;
<a name="l01515"></a>01515                     }
<a name="l01516"></a>01516 
<a name="l01517"></a>01517 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01518"></a>01518 <span class="preprocessor"></span>                    printf(<span class="stringliteral">"moving left y %x z %d dy %d\n"</span>, sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>, z, dy);
<a name="l01519"></a>01519 <span class="preprocessor">#endif</span>
<a name="l01520"></a>01520 <span class="preprocessor"></span>
<a name="l01521"></a>01521                     <span class="keywordflow">break</span>;
<a name="l01522"></a>01522             }
<a name="l01523"></a>01523         }
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01527"></a>01527 <span class="preprocessor"></span>    printf(<span class="stringliteral">"speed dx %d dy %d\n"</span>, dx, dy);
<a name="l01528"></a>01528 <span class="preprocessor">#endif</span>
<a name="l01529"></a>01529 <span class="preprocessor"></span>
<a name="l01530"></a>01530 <span class="preprocessor">#define AHEAD 8</span>
<a name="l01531"></a>01531 <span class="preprocessor"></span>
<a name="l01532"></a>01532     otx = (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> + (Dx[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * AHEAD)) &gt;&gt;4;
<a name="l01533"></a>01533     oty = (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> + (Dy[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * AHEAD)) &gt;&gt;4;
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     otx = <a class="code" href="micropolis_8h.html#c72a52ee0b2b2f779f6c8714f0c42f0d">clamp</a>(otx, 0, <a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 1);
<a name="l01536"></a>01536     oty = <a class="code" href="micropolis_8h.html#c72a52ee0b2b2f779f6c8714f0c42f0d">clamp</a>(oty, 0, <a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 1);
<a name="l01537"></a>01537 
<a name="l01538"></a>01538     tx = (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> + dx + (Dx[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * AHEAD)) &gt;&gt;4;
<a name="l01539"></a>01539     ty = (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> + dy + (Dy[sprite-&gt;<a class="code" href="classSimSprite.html#43e3499729a01fe47e356222928c6d3f">dir</a>] * AHEAD)) &gt;&gt;4;
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     tx = <a class="code" href="micropolis_8h.html#c72a52ee0b2b2f779f6c8714f0c42f0d">clamp</a>(tx, 0, <a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 1);
<a name="l01542"></a>01542     ty = <a class="code" href="micropolis_8h.html#c72a52ee0b2b2f779f6c8714f0c42f0d">clamp</a>(ty, 0, <a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 1);
<a name="l01543"></a>01543 
<a name="l01544"></a>01544     <span class="keywordflow">if</span> (tx != otx || ty != oty) {
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 <span class="preprocessor">#ifdef DEBUGBUS</span>
<a name="l01547"></a>01547 <span class="preprocessor"></span>        printf(<span class="stringliteral">"drive from tile %d %d to %d %d\n"</span>,
<a name="l01548"></a>01548                otx, oty, tx, ty);
<a name="l01549"></a>01549 <span class="preprocessor">#endif</span>
<a name="l01550"></a>01550 <span class="preprocessor"></span>
<a name="l01551"></a>01551         z = <a class="code" href="classMicropolis.html#707bf68e4174539d4ad3653e4018a062">canDriveOn</a>(tx, ty);
<a name="l01552"></a>01552 
<a name="l01553"></a>01553         <span class="keywordflow">if</span> (z == 0) {
<a name="l01554"></a>01554 
<a name="l01555"></a>01555             <span class="comment">/* can't drive forward into a new tile */</span>
<a name="l01556"></a>01556             <span class="keywordflow">if</span> (speed == 8) {
<a name="l01557"></a>01557                 bulldozerTool(tx, ty);
<a name="l01558"></a>01558             } <span class="keywordflow">else</span> {
<a name="l01559"></a>01559             }
<a name="l01560"></a>01560 
<a name="l01561"></a>01561         } <span class="keywordflow">else</span> {
<a name="l01562"></a>01562 
<a name="l01563"></a>01563             <span class="comment">/* drive forward into a new tile */</span>
<a name="l01564"></a>01564             <span class="keywordflow">if</span> (z &gt; 0) {
<a name="l01565"></a>01565                 <span class="comment">/* smooth */</span>
<a name="l01566"></a>01566             } <span class="keywordflow">else</span> {
<a name="l01567"></a>01567                 <span class="comment">/* bumpy */</span>
<a name="l01568"></a>01568                 dx /= 2;
<a name="l01569"></a>01569                 dy /= 2;
<a name="l01570"></a>01570             }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572         }
<a name="l01573"></a>01573     }
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     tx = (sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a> + dx) &gt;&gt;4;
<a name="l01576"></a>01576     ty = (sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a> + dy) &gt;&gt;4;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578     z = <a class="code" href="classMicropolis.html#707bf68e4174539d4ad3653e4018a062">canDriveOn</a>(tx, ty);
<a name="l01579"></a>01579 
<a name="l01580"></a>01580     <span class="keywordflow">if</span> (z &gt; 0) {
<a name="l01581"></a>01581         <span class="comment">/* cool, cruise along */</span>
<a name="l01582"></a>01582     } <span class="keywordflow">else</span> {
<a name="l01583"></a>01583         <span class="keywordflow">if</span> (z &lt; 0) {
<a name="l01584"></a>01584             <span class="comment">/* bumpy */</span>
<a name="l01585"></a>01585         } <span class="keywordflow">else</span> {
<a name="l01586"></a>01586             <span class="comment">/* something in the way */</span>
<a name="l01587"></a>01587         }
<a name="l01588"></a>01588     }
<a name="l01589"></a>01589 
<a name="l01590"></a>01590     sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> += dx;
<a name="l01591"></a>01591     sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> += dy;
<a name="l01592"></a>01592 
<a name="l01593"></a>01593     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#680a0861f9870a09279c685cfd077d96" title="Enable disasters.">enableDisasters</a>) {
<a name="l01594"></a>01594         <a class="code" href="classSimSprite.html">SimSprite</a> *s;
<a name="l01595"></a>01595         <span class="keywordtype">int</span> explode = 0;
<a name="l01596"></a>01596 
<a name="l01597"></a>01597         <span class="keywordflow">for</span> (s = <a class="code" href="classMicropolis.html#041df1c62a5c8d6b0379d003d3c509f6" title="List of active sprites.">spriteList</a>; s != NULL; s = s-&gt;<a class="code" href="classSimSprite.html#a4e9778d43f38a912cbe560b893637bc" title="Pointer to next SimSprite object in the list.">next</a>) {
<a name="l01598"></a>01598             <span class="keywordflow">if</span> (sprite != s &amp;&amp; s-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> != 0
<a name="l01599"></a>01599                     &amp;&amp; (s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa7d3c2d6672ee99804110a6bd1822807" title="Bus sprite.">SPRITE_BUS</a>
<a name="l01600"></a>01600                         || (s-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a> == <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a> &amp;&amp; s-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> != 5))
<a name="l01601"></a>01601                     &amp;&amp; <a class="code" href="classMicropolis.html#18cf1ce85bfc2ff40802b4c0a80dc754">checkSpriteCollision</a>(sprite, s)) {
<a name="l01602"></a>01602                 <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">explodeSprite</a>(s);
<a name="l01603"></a>01603                 explode = 1;
<a name="l01604"></a>01604             }
<a name="l01605"></a>01605         }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607         <span class="keywordflow">if</span> (explode) {
<a name="l01608"></a>01608             <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">explodeSprite</a>(sprite);
<a name="l01609"></a>01609         }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612 }
<a name="l01613"></a>01613 
<a name="l01614"></a>01614 
<a name="l01621"></a><a class="code" href="classMicropolis.html#707bf68e4174539d4ad3653e4018a062">01621</a> <span class="keywordtype">int</span> <a class="code" href="classMicropolis.html#707bf68e4174539d4ad3653e4018a062">Micropolis::canDriveOn</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01622"></a>01622 {
<a name="l01623"></a>01623     <span class="keywordtype">int</span> tile;
<a name="l01624"></a>01624 
<a name="l01625"></a>01625     <span class="keywordflow">if</span> (!<a class="code" href="classMicropolis.html#c88ae46202ab81120718c9f079d2dbfa">testBounds</a>(x, y)) {
<a name="l01626"></a>01626         <span class="keywordflow">return</span> 0;
<a name="l01627"></a>01627     }
<a name="l01628"></a>01628 
<a name="l01629"></a>01629     tile = <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf424839a505f5307c64ce70cb21d88b9766" title="Mask for the MapTileCharacters part of the tile.">LOMASK</a>;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631     <span class="keywordflow">if</span> ((tile &gt;= ROADBASE &amp;&amp; tile &lt;= LASTROAD &amp;&amp; tile != BRWH &amp;&amp; tile != BRWV)
<a name="l01632"></a>01632               || tile == HRAILROAD || tile == VRAILROAD) {
<a name="l01633"></a>01633         <span class="keywordflow">return</span> 1;
<a name="l01634"></a>01634     }
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     <span class="keywordflow">if</span> (tile == <a class="code" href="micropolis_8h.html#25ebd6c017a806d6cc704d20f857443ecc4e9a6b72b8cb231cf382b6320aeed2" title="Clear tile.">DIRT</a> || <a class="code" href="classMicropolis.html#206154d7473eeef26cfd14c4fb08acea">tally</a>(tile)) {
<a name="l01637"></a>01637         <span class="keywordflow">return</span> -1;
<a name="l01638"></a>01638     }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640     <span class="keywordflow">return</span> 0;
<a name="l01641"></a>01641 }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643 
<a name="l01649"></a><a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">01649</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#066d0de15f9a85cc5c3d7beaec7e9b93">Micropolis::explodeSprite</a>(<a class="code" href="classSimSprite.html">SimSprite</a> *sprite)
<a name="l01650"></a>01650 {
<a name="l01651"></a>01651     <span class="keywordtype">int</span> x, y;
<a name="l01652"></a>01652 
<a name="l01653"></a>01653     sprite-&gt;<a class="code" href="classSimSprite.html#eca631659008c33d7d04db407d575c75" title="Frame (0 means non-active sprite).">frame</a> = 0;
<a name="l01654"></a>01654 
<a name="l01655"></a>01655     x = sprite-&gt;<a class="code" href="classSimSprite.html#0c2a65810a310e1e1fc95d00c3c6f394" title="X coordinate of the sprite in pixels?">x</a> + sprite-&gt;<a class="code" href="classSimSprite.html#f5d68ae91b32b04fbc26d88b82ef1ccc" title="Offset of the hot-spot relative to SimSprite::x?">xHot</a>;
<a name="l01656"></a>01656     y = sprite-&gt;<a class="code" href="classSimSprite.html#e1600ecb4f1cb3899f7facc369c7e25e" title="Y coordinate of the sprite in pixels?">y</a> + sprite-&gt;<a class="code" href="classSimSprite.html#4ee651480a2baf67fa98727f1e9edab5" title="Offset of the hot-spot relative to SimSprite::y?">yHot</a>;
<a name="l01657"></a>01657     <a class="code" href="classMicropolis.html#d1bf05d303d7898887f9785695e34963">makeExplosionAt</a>(x, y);
<a name="l01658"></a>01658 
<a name="l01659"></a>01659     x = (x &gt;&gt;4);
<a name="l01660"></a>01660     y = (y &gt;&gt;4);
<a name="l01661"></a>01661 
<a name="l01662"></a>01662     <span class="keywordflow">switch</span> (sprite-&gt;<a class="code" href="classSimSprite.html#5c8ac895626cad194a4ffa2a5a9eb79b" title="Type of the sprite (TRA -- BUS).">type</a>) {
<a name="l01663"></a>01663 
<a name="l01664"></a>01664         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a>:
<a name="l01665"></a>01665             <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca820113645918170dc8feceffcac0cca5a4d" title="A plane has crashed !">MESSAGE_PLANE_CRASHED</a>, x, y, <span class="keyword">true</span>);
<a name="l01666"></a>01666             <span class="keywordflow">break</span>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab6ba5d8c2fd181feca500a46b00ef860" title="Ship.">SPRITE_SHIP</a>:
<a name="l01669"></a>01669             <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca8200e418ae0c6c3cc2cea54deb88d599e39" title="25: Shipwreck reported !">MESSAGE_SHIP_CRASHED</a>, x, y, <span class="keyword">true</span>);
<a name="l01670"></a>01670             <span class="keywordflow">break</span>;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a>:
<a name="l01673"></a>01673             <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca8201bdfb72dab99f395105d8a314b498268" title="A train crashed !">MESSAGE_TRAIN_CRASHED</a>, x, y, <span class="keyword">true</span>);
<a name="l01674"></a>01674             <span class="keywordflow">break</span>;
<a name="l01675"></a>01675 
<a name="l01676"></a>01676         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a>:
<a name="l01677"></a>01677             <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca82044e1a4b60a18659c86c68416c1610273" title="A helicopter crashed !">MESSAGE_HELICOPTER_CRASHED</a>, x, y, <span class="keyword">true</span>);
<a name="l01678"></a>01678             <span class="keywordflow">break</span>;
<a name="l01679"></a>01679 
<a name="l01680"></a>01680         <span class="keywordflow">case</span> <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa7d3c2d6672ee99804110a6bd1822807" title="Bus sprite.">SPRITE_BUS</a>:
<a name="l01681"></a>01681             <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca8201bdfb72dab99f395105d8a314b498268" title="A train crashed !">MESSAGE_TRAIN_CRASHED</a>, x, y, <span class="keyword">true</span>); <span class="comment">/* XXX for now */</span>
<a name="l01682"></a>01682             <span class="keywordflow">break</span>;
<a name="l01683"></a>01683 
<a name="l01684"></a>01684     }
<a name="l01685"></a>01685 
<a name="l01686"></a>01686     <span class="comment">// Convert sprite coordinates to tile coordinates.</span>
<a name="l01687"></a>01687     <a class="code" href="classMicropolis.html#a415366f5d827b0ed7a6c458f9704e2e">makeSound</a>(<span class="stringliteral">"city"</span>, <span class="stringliteral">"ExplosionHigh"</span>, x, y); <span class="comment">/* explosion */</span>
<a name="l01688"></a>01688 
<a name="l01689"></a>01689     <span class="keywordflow">return</span>;
<a name="l01690"></a>01690 }
<a name="l01691"></a>01691 
<a name="l01692"></a>01692 
<a name="l01693"></a>01693 <span class="keywordtype">bool</span> Micropolis::checkWet(<span class="keywordtype">int</span> x)
<a name="l01694"></a>01694 {
<a name="l01695"></a>01695     <span class="keywordflow">if</span> (x == HPOWER || x == VPOWER || x == HRAIL || x == VRAIL
<a name="l01696"></a>01696               || x == BRWH || x == BRWV) {
<a name="l01697"></a>01697         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01698"></a>01698     } <span class="keywordflow">else</span> {
<a name="l01699"></a>01699         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01700"></a>01700     }
<a name="l01701"></a>01701 }
<a name="l01702"></a>01702 
<a name="l01703"></a>01703 
<a name="l01709"></a><a class="code" href="classMicropolis.html#f8e90c53f354cae1aee048cddcd9bd09">01709</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#f8e90c53f354cae1aee048cddcd9bd09">Micropolis::destroyMapTile</a>(<span class="keywordtype">int</span> ox, <span class="keywordtype">int</span> oy)
<a name="l01710"></a>01710 {
<a name="l01711"></a>01711     <span class="keywordtype">short</span> t, z, x, y;
<a name="l01712"></a>01712 
<a name="l01713"></a>01713     x = ox &gt;&gt;4;
<a name="l01714"></a>01714     y = oy &gt;&gt;4;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <span class="keywordflow">if</span> (!<a class="code" href="classMicropolis.html#c88ae46202ab81120718c9f079d2dbfa">testBounds</a>(x, y)) {
<a name="l01717"></a>01717         <span class="keywordflow">return</span>;
<a name="l01718"></a>01718     }
<a name="l01719"></a>01719 
<a name="l01720"></a>01720     z = <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y];
<a name="l01721"></a>01721     t = z &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf424839a505f5307c64ce70cb21d88b9766" title="Mask for the MapTileCharacters part of the tile.">LOMASK</a>;
<a name="l01722"></a>01722 
<a name="l01723"></a>01723     <span class="keywordflow">if</span> (t &gt;= TREEBASE) {
<a name="l01724"></a>01724         <span class="keywordflow">if</span> (!(z &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf42014ad71e7cec15ec26c02cfad2e3356a" title="bit 13, tile can be lit.">BURNBIT</a>)) {
<a name="l01725"></a>01725 
<a name="l01726"></a>01726           <span class="keywordflow">if</span> (t &gt;= ROADBASE &amp;&amp; t &lt;= LASTROAD) {
<a name="l01727"></a>01727               <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] = RIVER;
<a name="l01728"></a>01728           }
<a name="l01729"></a>01729 
<a name="l01730"></a>01730           <span class="keywordflow">return</span>;
<a name="l01731"></a>01731         }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733         <span class="keywordflow">if</span> (z &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf4251e1c6ee74965ce4cb1bc90467824add" title="bit 10, tile is the center tile of the zone.">ZONEBIT</a>) {
<a name="l01734"></a>01734 
<a name="l01735"></a>01735             <a class="code" href="classMicropolis.html#19582762daeb556c56b42158922c3bfa">startFireInZone</a>(x, y, z);
<a name="l01736"></a>01736 
<a name="l01737"></a>01737             <span class="keywordflow">if</span> (t &gt; RZB) {
<a name="l01738"></a>01738                 <a class="code" href="classMicropolis.html#d1bf05d303d7898887f9785695e34963">makeExplosionAt</a>(ox, oy);
<a name="l01739"></a>01739             }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741         }
<a name="l01742"></a>01742 
<a name="l01743"></a>01743         <span class="keywordflow">if</span> (checkWet(t)) {
<a name="l01744"></a>01744             <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] = RIVER;
<a name="l01745"></a>01745         } <span class="keywordflow">else</span> {
<a name="l01746"></a>01746             <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] = (<a class="code" href="classMicropolis.html#61ce6bf454df68a934d7af6e8285a668">doAnimation</a> ? TINYEXP : (LASTTINYEXP - 3))
<a name="l01747"></a>01747                       | <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf42b718f843cf91845b62b23fc03942d095" title="bit 12, tile is bulldozable.">BULLBIT</a> | <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf42e64f799e649a284bedb0bac81afb9446" title="bit 11, tile is animated.">ANIMBIT</a>;
<a name="l01748"></a>01748         }
<a name="l01749"></a>01749     }
<a name="l01750"></a>01750 }
<a name="l01751"></a>01751 
<a name="l01752"></a>01752 
<a name="l01759"></a><a class="code" href="classMicropolis.html#19582762daeb556c56b42158922c3bfa">01759</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#19582762daeb556c56b42158922c3bfa">Micropolis::startFireInZone</a>(<span class="keywordtype">int</span> Xloc, <span class="keywordtype">int</span> Yloc, <span class="keywordtype">int</span> ch)
<a name="l01760"></a>01760 {
<a name="l01761"></a>01761     <span class="keywordtype">short</span> Xtem, Ytem;
<a name="l01762"></a>01762     <span class="keywordtype">short</span> x, y, XYmax;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764     <span class="keywordtype">int</span> value = <a class="code" href="classMicropolis.html#deb19ae202d9fa5e3252daccc8a46165">rateOfGrowthMap</a>.<a class="code" href="classMap.html#730dab474e4d447c83769738e7c90d0c">worldGet</a>(Xloc, Yloc);
<a name="l01765"></a>01765     value = <a class="code" href="micropolis_8h.html#c72a52ee0b2b2f779f6c8714f0c42f0d">clamp</a>(value - 20, -200, 200);
<a name="l01766"></a>01766     <a class="code" href="classMicropolis.html#deb19ae202d9fa5e3252daccc8a46165">rateOfGrowthMap</a>.<a class="code" href="classMap.html#e930c1a5a1f5f60ce791b01e83dc14be">worldSet</a>(Xloc, Yloc, value);
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     ch &amp;= <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf424839a505f5307c64ce70cb21d88b9766" title="Mask for the MapTileCharacters part of the tile.">LOMASK</a>;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="keywordflow">if</span> (ch &lt; <a class="code" href="micropolis_8h.html#25ebd6c017a806d6cc704d20f857443e7670a19e6e9c7d0984729552cf452588" title="Top-left tile of the seaport.">PORTBASE</a>) {
<a name="l01771"></a>01771         XYmax = 2;
<a name="l01772"></a>01772     } <span class="keywordflow">else</span> {
<a name="l01773"></a>01773         <span class="keywordflow">if</span> (ch == AIRPORT) {
<a name="l01774"></a>01774             XYmax = 5;
<a name="l01775"></a>01775         } <span class="keywordflow">else</span> {
<a name="l01776"></a>01776             XYmax = 4;
<a name="l01777"></a>01777         }
<a name="l01778"></a>01778     }
<a name="l01779"></a>01779 
<a name="l01780"></a>01780     <span class="keywordflow">for</span> (x = -1; x &lt; XYmax; x++) {
<a name="l01781"></a>01781         <span class="keywordflow">for</span> (y = -1; y &lt; XYmax; y++) {
<a name="l01782"></a>01782 
<a name="l01783"></a>01783             Xtem = Xloc + x;
<a name="l01784"></a>01784             Ytem = Yloc + y;
<a name="l01785"></a>01785 
<a name="l01786"></a>01786             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#c88ae46202ab81120718c9f079d2dbfa">testBounds</a>(Xtem, Ytem) &amp;&amp; (<a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[Xtem][Ytem] &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf424839a505f5307c64ce70cb21d88b9766" title="Mask for the MapTileCharacters part of the tile.">LOMASK</a>) &gt;= ROADBASE) {
<a name="l01787"></a>01787                 <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[Xtem][Ytem] |= <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf42b718f843cf91845b62b23fc03942d095" title="bit 12, tile is bulldozable.">BULLBIT</a>;
<a name="l01788"></a>01788             }
<a name="l01789"></a>01789 
<a name="l01790"></a>01790         }
<a name="l01791"></a>01791     }
<a name="l01792"></a>01792 }
<a name="l01793"></a>01793 
<a name="l01794"></a>01794 
<a name="l01800"></a><a class="code" href="classMicropolis.html#5b7cfd94c47bd468d19fa0635691c9e0">01800</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#5b7cfd94c47bd468d19fa0635691c9e0">Micropolis::startFire</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01801"></a>01801 {
<a name="l01802"></a>01802     <span class="keywordtype">int</span> t, z;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804     x &gt;&gt;= 4;
<a name="l01805"></a>01805     y &gt;&gt;= 4;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807     <span class="keywordflow">if</span> (!<a class="code" href="classMicropolis.html#c88ae46202ab81120718c9f079d2dbfa">testBounds</a>(x, y)) {
<a name="l01808"></a>01808         <span class="keywordflow">return</span>;
<a name="l01809"></a>01809     }
<a name="l01810"></a>01810 
<a name="l01811"></a>01811     z = <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y];
<a name="l01812"></a>01812     t = z &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf424839a505f5307c64ce70cb21d88b9766" title="Mask for the MapTileCharacters part of the tile.">LOMASK</a>;
<a name="l01813"></a>01813 
<a name="l01814"></a>01814     <span class="keywordflow">if</span> (!(z &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf42014ad71e7cec15ec26c02cfad2e3356a" title="bit 13, tile can be lit.">BURNBIT</a>) &amp;&amp; t != <a class="code" href="micropolis_8h.html#25ebd6c017a806d6cc704d20f857443ecc4e9a6b72b8cb231cf382b6320aeed2" title="Clear tile.">DIRT</a>) {
<a name="l01815"></a>01815         <span class="keywordflow">return</span>;
<a name="l01816"></a>01816     }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818     <span class="keywordflow">if</span> (z &amp; <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf4251e1c6ee74965ce4cb1bc90467824add" title="bit 10, tile is the center tile of the zone.">ZONEBIT</a>) {
<a name="l01819"></a>01819         <span class="keywordflow">return</span>;
<a name="l01820"></a>01820     }
<a name="l01821"></a>01821 
<a name="l01822"></a>01822     <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] = <a class="code" href="classMicropolis.html#8d4dac1a71df3f069159d198a360caf4">randomFire</a>();
<a name="l01823"></a>01823 }
<a name="l01824"></a>01824 
<a name="l01825"></a>01825 
<a name="l01831"></a><a class="code" href="classMicropolis.html#ab534afa734549fec7e00bc34108e60b">01831</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#ab534afa734549fec7e00bc34108e60b">Micropolis::generateTrain</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01832"></a>01832 {
<a name="l01833"></a>01833     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#9a031709dddb583f85715eb66c454bc9">totalPop</a> &gt; 20 &amp;&amp; <a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a>) == NULL &amp;&amp; <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(25) == 0) {
<a name="l01834"></a>01834         <a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">makeSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a9a8ce497fbb98792cf4988ca1e06f965" title="Train sprite.">SPRITE_TRAIN</a>, (x &lt;&lt;4) + TRA_GROOVE_X, (y &lt;&lt;4) + TRA_GROOVE_Y);
<a name="l01835"></a>01835     }
<a name="l01836"></a>01836 }
<a name="l01837"></a>01837 
<a name="l01838"></a>01838 
<a name="l01844"></a><a class="code" href="classMicropolis.html#bb799e8ecf284628b802fe728ca9d175">01844</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#bb799e8ecf284628b802fe728ca9d175">Micropolis::generateBus</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01845"></a>01845 {
<a name="l01846"></a>01846     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa7d3c2d6672ee99804110a6bd1822807" title="Bus sprite.">SPRITE_BUS</a>) == NULL &amp;&amp; <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(25) == 0) {
<a name="l01847"></a>01847         <a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">makeSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa7d3c2d6672ee99804110a6bd1822807" title="Bus sprite.">SPRITE_BUS</a>, (x &lt;&lt;4) + BUS_GROOVE_X, (y &lt;&lt;4) + BUS_GROOVE_Y);
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849 }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851 
<a name="l01853"></a><a class="code" href="classMicropolis.html#85730dec6260ac2cf76edd4dfe24186b">01853</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#85730dec6260ac2cf76edd4dfe24186b">Micropolis::generateShip</a>()
<a name="l01854"></a>01854 {
<a name="l01855"></a>01855     <span class="keywordtype">short</span> x, y;
<a name="l01856"></a>01856 
<a name="l01857"></a>01857     <span class="keywordflow">if</span> (!(<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 3)) {
<a name="l01858"></a>01858         <span class="keywordflow">for</span> (x = 4; x &lt; <a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 2; x++) {
<a name="l01859"></a>01859             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][0] == CHANNEL)  {
<a name="l01860"></a>01860                 <a class="code" href="classMicropolis.html#e0a29d19ec96c0b461a31a29286d0624">makeShipHere</a>(x, 0);
<a name="l01861"></a>01861                 <span class="keywordflow">return</span>;
<a name="l01862"></a>01862             }
<a name="l01863"></a>01863         }
<a name="l01864"></a>01864     }
<a name="l01865"></a>01865 
<a name="l01866"></a>01866     <span class="keywordflow">if</span> (!(<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 3)) {
<a name="l01867"></a>01867         <span class="keywordflow">for</span> (y = 1; y &lt; <a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 2; y++) {
<a name="l01868"></a>01868             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[0][y] == CHANNEL)  {
<a name="l01869"></a>01869                 <a class="code" href="classMicropolis.html#e0a29d19ec96c0b461a31a29286d0624">makeShipHere</a>(0, y);
<a name="l01870"></a>01870                 <span class="keywordflow">return</span>;
<a name="l01871"></a>01871             }
<a name="l01872"></a>01872         }
<a name="l01873"></a>01873     }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875     <span class="keywordflow">if</span> (!(<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 3)) {
<a name="l01876"></a>01876         <span class="keywordflow">for</span> (x = 4; x &lt; <a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 2; x++) {
<a name="l01877"></a>01877             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 1] == CHANNEL)  {
<a name="l01878"></a>01878                 <a class="code" href="classMicropolis.html#e0a29d19ec96c0b461a31a29286d0624">makeShipHere</a>(x, <a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 1);
<a name="l01879"></a>01879                 <span class="keywordflow">return</span>;
<a name="l01880"></a>01880             }
<a name="l01881"></a>01881         }
<a name="l01882"></a>01882     }
<a name="l01883"></a>01883 
<a name="l01884"></a>01884     <span class="keywordflow">if</span> (!(<a class="code" href="classMicropolis.html#65b8303764cfefd498ee1013a1c445ae">getRandom16</a>() &amp; 3)) {
<a name="l01885"></a>01885         <span class="keywordflow">for</span> (y = 1; y &lt; <a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 2; y++) {
<a name="l01886"></a>01886             <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 1][y] == CHANNEL)  {
<a name="l01887"></a>01887                 <a class="code" href="classMicropolis.html#e0a29d19ec96c0b461a31a29286d0624">makeShipHere</a>(<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 1, y);
<a name="l01888"></a>01888                 <span class="keywordflow">return</span>;
<a name="l01889"></a>01889             }
<a name="l01890"></a>01890         }
<a name="l01891"></a>01891     }
<a name="l01892"></a>01892 }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894 
<a name="l01900"></a><a class="code" href="classMicropolis.html#e0a29d19ec96c0b461a31a29286d0624">01900</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#e0a29d19ec96c0b461a31a29286d0624">Micropolis::makeShipHere</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01901"></a>01901 {
<a name="l01902"></a>01902     <a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">makeSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab6ba5d8c2fd181feca500a46b00ef860" title="Ship.">SPRITE_SHIP</a>, (x &lt;&lt;4) - (48 - 1), (y &lt;&lt;4));
<a name="l01903"></a>01903 }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905 
<a name="l01912"></a><a class="code" href="classMicropolis.html#5802d50d928358a73d0369705b5f8472">01912</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#5802d50d928358a73d0369705b5f8472">Micropolis::makeMonster</a>()
<a name="l01913"></a>01913 {
<a name="l01914"></a>01914     <span class="keywordtype">int</span> x, y, z, done = 0;
<a name="l01915"></a>01915     <a class="code" href="classSimSprite.html">SimSprite</a> *sprite;
<a name="l01916"></a>01916 
<a name="l01917"></a>01917     sprite = <a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a8ce060f17cd3f13f338aac493a1d90c4" title="Scary monster.">SPRITE_MONSTER</a>);
<a name="l01918"></a>01918     <span class="keywordflow">if</span> (sprite != NULL) {
<a name="l01919"></a>01919         sprite-&gt;<a class="code" href="classSimSprite.html#623b97f6165a6428d5586ea1b7ceaeca">soundCount</a> = 1;
<a name="l01920"></a>01920         sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 1000;
<a name="l01921"></a>01921         sprite-&gt;<a class="code" href="classSimSprite.html#395260ef8e5d30c2ccb1955d35af7b12" title="Destination X coordinate of the sprite.">destX</a> = <a class="code" href="classMicropolis.html#75662ccbb6b1260699fba7729cd16f67" title="X coordinate of most polluted area.">pollutionMaxX</a> &lt;&lt;4;
<a name="l01922"></a>01922         sprite-&gt;<a class="code" href="classSimSprite.html#87f26f696fe313b0b6427decc8d50402" title="Destination Y coordinate of the sprite.">destY</a> = <a class="code" href="classMicropolis.html#5e6fd13f9ab16aa4b791ef9c9d229c53" title="Y coordinate of most polluted area.">pollutionMaxY</a> &lt;&lt;4;
<a name="l01923"></a>01923         <span class="keywordflow">return</span>;
<a name="l01924"></a>01924     }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926     <span class="keywordflow">for</span> (z = 0; z &lt; 300; z++)  {
<a name="l01927"></a>01927 
<a name="l01928"></a>01928         x = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> - 20) + 10;
<a name="l01929"></a>01929         y = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>(<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> - 10) + 5;
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] == RIVER || <a class="code" href="classMicropolis.html#9caa2dda6edc913f82c4c48c77ae7859">map</a>[x][y] == RIVER + <a class="code" href="micropolis_8h.html#93d97f16dc324013ff1e55444bddaf42b718f843cf91845b62b23fc03942d095" title="bit 12, tile is bulldozable.">BULLBIT</a>) {
<a name="l01932"></a>01932             <a class="code" href="classMicropolis.html#58c7f8cc917b64b696f0d286f91433af">makeMonsterAt</a>(x, y);
<a name="l01933"></a>01933             done = 1;
<a name="l01934"></a>01934             <span class="keywordflow">break</span>;
<a name="l01935"></a>01935         }
<a name="l01936"></a>01936 
<a name="l01937"></a>01937     }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939     <span class="keywordflow">if</span> (!done) {
<a name="l01940"></a>01940         <a class="code" href="classMicropolis.html#58c7f8cc917b64b696f0d286f91433af">makeMonsterAt</a>(60, 50);
<a name="l01941"></a>01941     }
<a name="l01942"></a>01942 
<a name="l01943"></a>01943 }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945 
<a name="l01951"></a><a class="code" href="classMicropolis.html#58c7f8cc917b64b696f0d286f91433af">01951</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#58c7f8cc917b64b696f0d286f91433af">Micropolis::makeMonsterAt</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01952"></a>01952 {
<a name="l01953"></a>01953     <a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">makeSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a8ce060f17cd3f13f338aac493a1d90c4" title="Scary monster.">SPRITE_MONSTER</a>, (x &lt;&lt; 4) + 48, (y &lt;&lt; 4));
<a name="l01954"></a>01954     <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca820514360046f6479da97980af40dd156ee" title="A Monster has been sighted !!">MESSAGE_MONSTER_SIGHTED</a>, x + 5, y, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l01955"></a>01955 }
<a name="l01956"></a>01956 
<a name="l01957"></a>01957 
<a name="l01964"></a><a class="code" href="classMicropolis.html#05f399e07ed69d228f50cbf23bcaad38">01964</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#05f399e07ed69d228f50cbf23bcaad38">Micropolis::generateCopter</a>(<span class="keyword">const</span> <a class="code" href="classPosition.html">Position</a> &amp;pos)
<a name="l01965"></a>01965 {
<a name="l01966"></a>01966     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a>) != NULL) {
<a name="l01967"></a>01967         <span class="keywordflow">return</span>;
<a name="l01968"></a>01968     }
<a name="l01969"></a>01969 
<a name="l01970"></a>01970     <a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">makeSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31aa40883d3858eeb1bdd4a0e27b5ffb153" title="Helicopter sprite.">SPRITE_HELICOPTER</a>, (pos.<a class="code" href="classPosition.html#0fb7c4aeb3e29fdeb6a67ff5006e6e09" title="Horizontal coordinate of the position.">posX</a> &lt;&lt; 4), (pos.<a class="code" href="classPosition.html#0a3ea286300d4c67e46a546f6d12b759" title="Vertical coordnate of the position.">posY</a> &lt;&lt; 4) + 30);
<a name="l01971"></a>01971 }
<a name="l01972"></a>01972 
<a name="l01973"></a>01973 
<a name="l01980"></a><a class="code" href="classMicropolis.html#6b7c5e165b56a69ffd1b5deee03f1938">01980</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#6b7c5e165b56a69ffd1b5deee03f1938">Micropolis::generatePlane</a>(<span class="keyword">const</span> <a class="code" href="classPosition.html">Position</a> &amp;pos)
<a name="l01981"></a>01981 {
<a name="l01982"></a>01982     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a>) != NULL) {
<a name="l01983"></a>01983         <span class="keywordflow">return</span>;
<a name="l01984"></a>01984     }
<a name="l01985"></a>01985 
<a name="l01986"></a>01986     <a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">makeSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a44c7f6a65cc2597239f9c4babfdbc296" title="Airplane sprite.">SPRITE_AIRPLANE</a>, (pos.<a class="code" href="classPosition.html#0fb7c4aeb3e29fdeb6a67ff5006e6e09" title="Horizontal coordinate of the position.">posX</a> &lt;&lt;4) + 48, (pos.<a class="code" href="classPosition.html#0a3ea286300d4c67e46a546f6d12b759" title="Vertical coordnate of the position.">posY</a> &lt;&lt;4) + 12);
<a name="l01987"></a>01987 }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989 
<a name="l01991"></a><a class="code" href="classMicropolis.html#aa1328c8b2071e0a652fde874db04c56">01991</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#aa1328c8b2071e0a652fde874db04c56">Micropolis::makeTornado</a>()
<a name="l01992"></a>01992 {
<a name="l01993"></a>01993     <span class="keywordtype">short</span> x, y;
<a name="l01994"></a>01994     <a class="code" href="classSimSprite.html">SimSprite</a> *sprite;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996     sprite = <a class="code" href="classMicropolis.html#904eb1872ee75c3ba18f47cefc8af4cd">getSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a4a4a8673a220292b3a02bca1e886b847" title="Tornado sprite.">SPRITE_TORNADO</a>);
<a name="l01997"></a>01997     <span class="keywordflow">if</span> (sprite != NULL) {
<a name="l01998"></a>01998         sprite-&gt;<a class="code" href="classSimSprite.html#bcb8905b464e93a69bcc3df299148f46">count</a> = 200;
<a name="l01999"></a>01999         <span class="keywordflow">return</span>;
<a name="l02000"></a>02000     }
<a name="l02001"></a>02001 
<a name="l02002"></a>02002     x = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>((<a class="code" href="map__type_8h.html#e6df22d5005e60ca7b2da133fcff3c24">WORLD_W</a> &lt;&lt;4) - 800) + 400;
<a name="l02003"></a>02003     y = <a class="code" href="classMicropolis.html#5db230dbb510ee57bedcfb1f92ff74eb">getRandom</a>((<a class="code" href="map__type_8h.html#d649289f6f5a81082f7cceae8b94d137">WORLD_H</a> &lt;&lt;4) - 200) + 100;
<a name="l02004"></a>02004 
<a name="l02005"></a>02005     <a class="code" href="classMicropolis.html#d278d2acbb8c6597fa71486909b002b1">makeSprite</a>(<a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31a4a4a8673a220292b3a02bca1e886b847" title="Tornado sprite.">SPRITE_TORNADO</a>, x, y);
<a name="l02006"></a>02006     <a class="code" href="classMicropolis.html#b36d9f4787fb9e65e26d9fc53946db74">sendMessage</a>(<a class="code" href="text_8h.html#db750b7bad44388671a77000934ca8208495a4f1a6b39cce80fb6ec8299d8846" title="Tornado reported !!">MESSAGE_TORNADO_SIGHTED</a>, (x &gt;&gt;4) + 3, (y &gt;&gt;4) + 2, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l02007"></a>02007 }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009 
<a name="l02015"></a><a class="code" href="classMicropolis.html#3bf4f78a732b9fd1a044105a166987f9">02015</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#3bf4f78a732b9fd1a044105a166987f9">Micropolis::makeExplosion</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l02016"></a>02016 {
<a name="l02017"></a>02017     <span class="keywordflow">if</span> (<a class="code" href="classMicropolis.html#c88ae46202ab81120718c9f079d2dbfa">testBounds</a>(x, y)) {
<a name="l02018"></a>02018         <a class="code" href="classMicropolis.html#d1bf05d303d7898887f9785695e34963">makeExplosionAt</a>((x &lt;&lt; 4) + 8, (y &lt;&lt; 4) + 8);
<a name="l02019"></a>02019     }
<a name="l02020"></a>02020 }
<a name="l02021"></a>02021 
<a name="l02022"></a>02022 
<a name="l02028"></a><a class="code" href="classMicropolis.html#d1bf05d303d7898887f9785695e34963">02028</a> <span class="keywordtype">void</span> <a class="code" href="classMicropolis.html#d1bf05d303d7898887f9785695e34963">Micropolis::makeExplosionAt</a>( <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l02029"></a>02029 {
<a name="l02030"></a>02030     <a class="code" href="classMicropolis.html#c704db0c9cdd214f77e69f58e4717d65">newSprite</a>(<span class="stringliteral">""</span>, <a class="code" href="micropolis_8h.html#c6fa10729dffeb6a192492f13c25e31ab747b593d9a3e5ebf0faeb4904838bdb" title="Explosion sprite.">SPRITE_EXPLOSION</a>, x - 40, y - 16);
<a name="l02031"></a>02031 }
<a name="l02032"></a>02032 
<a name="l02033"></a>02033 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Feb 2 09:19:22 2011 for Micropolis by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
